console||(console={log:function(){},debug:function(){},warn:function(){},error:function(){}}),Object.keys||(Object.keys=function(e){e!==Object(e)&&ximpel.error("Object.keys() called on a non-object");var t;for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&keys.push(t);return keys}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var i,s;if(null==this)throw new TypeError(" this is null or not defined");var o=Object(this),r=o.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(i=t),s=0;s<r;){var n;s in o&&(n=o[s],e.call(i,n,s,o)),s++}}),Array.prototype.filter||(Array.prototype.filter=function(e){"use strict";if(null==this)throw new TypeError;var t=Object(this),i=t.length>>>0;if("function"!=typeof e)throw new TypeError;for(var s=[],o=arguments[1],r=0;r<i;r++)if(r in t){var n=t[r];e.call(o,n,r,t)&&s.push(n)}return s}),Date.now||(Date.now=function(){return(new Date).getTime()});var ximpel={};ximpel.mediaTypeDefinitions={},ximpel.availableMediaTypes={},ximpel.ximpelTags=["ximpel","playlist","subject","media","description","score","variable","config","leadsTo","sequence","parallel","overlay","question","questions","option","source"],ximpel.LOG_PREFIX="[XIMPEL] ",ximpel.DEFAULT_PLAYER_ELEMENT="ximpel_player",ximpel.getElement=function(e){if(!e)return!1;if("string"==typeof e||e instanceof String){var t=$("#"+e);if(1===t.length)return t}else{if(ximpel.isElement(e))return $(e);if(ximpel.isJQueryObject(e)&&1===e.length)return e}return!1},ximpel.wrapInJquery=function(e){return e instanceof jQuery?e:$(e)},ximpel.isElement=function(e){return e instanceof HTMLElement},ximpel.isJQueryObject=function(e){return e instanceof jQuery},ximpel.logFunctionFactory=function(e,t,i){return function(s){e(ximpel.isObject(s)?s:t+"-"+i+"- "+s)}},ximpel.error=ximpel.logFunctionFactory(console.error.bind(console),ximpel.LOG_PREFIX,"ERROR"),ximpel.warn=ximpel.logFunctionFactory(console.warn.bind(console),ximpel.LOG_PREFIX,"WARNING"),ximpel.debug=ximpel.logFunctionFactory(console.debug.bind(console),ximpel.LOG_PREFIX,"DEBUG"),ximpel.log=ximpel.logFunctionFactory(console.log.bind(console),ximpel.LOG_PREFIX,"INFO"),ximpel.isObject=function(e){return e===Object(e)},ximpel.filterArrayOfObjects=function(e,t,i){return e.filter(function(e){return e[t]===i})},ximpel.registerMediaType=function(e){if(!e.hasOwnProperty("mediaTypeId"))return ximpel.warn('Media type registration failed! The media type registration object has no "mediaTypeId" property!'),!1;var t=ximpel.ximpelTags;if($.inArray(e.mediaTypeId,t)>-1)return ximpel.warn("Media type registration failed! The media type uses a tag-name ("+e.mediaTypeId+") that is already in use by ximpel!"),!1;var i=Object.getOwnPropertyNames(ximpel.availableMediaTypes);$.inArray(e.mediaTypeId,i)>-1&&ximpel.warn("Media type registration failed! The media type uses a 'mediaTypeId' ('"+e.mediaTypeId+"') that is already used by another media type."),ximpel.availableMediaTypes[e.mediaTypeId]=e},ximpel.View=function(){},ximpel.View.prototype.RENDER_EVENT="view_render",ximpel.View.prototype.ATTACH_EVENT="view_attach",ximpel.View.prototype.DETACH_EVENT="view_detach",ximpel.View.prototype.DESTROY_EVENT="view_destroyed",ximpel.View.prototype.init=function(e,t){this.pubSub=new ximpel.PubSub,t=t||$(document.createElement("div")),this.$el=ximpel.wrapInJquery(t),this.model=e},ximpel.View.prototype.render=function(e){this.renderView&&this.renderView(e);var t=this.$el.parent();return e&&t[0]!==e[0]&&(this.detach(),this.attachTo(e)),this.pubSub.publish(this.RENDER_EVENT),this},ximpel.View.prototype.destroy=function(){this.destroyView&&"function"==typeof this.destroyView&&this.destroyView(),this.$el&&this.$el.remove(),this.$el=null,this.model=null,this.pubSub&&this.pubSub.publish(this.DESTROY_EVENT),this.pubSub=null},ximpel.View.prototype.attachTo=function(e){return this.$el.appendTo(e),this.pubSub.publish(this.ATTACH_EVENT),this},ximpel.View.prototype.detach=function(){return this.$el.detach(),this.pubSub.publish(this.DETACH_EVENT),this},ximpel.View.prototype.onOneClick=function(e){return this.$el.one("click",e),this},ximpel.View.prototype.onClick=function(e){return this.$el.click(e),this},ximpel.View.prototype.onRender=function(e){return this.pubSub.subscribe(this.RENDER_EVENT,e),this},ximpel.View.prototype.onUpdate=function(e){return this.pubSub.subscribe(this.UPDATE_EVENT,e),this},ximpel.View.prototype.onAttach=function(e){return this.pubSub.subscribe(this.ATTACH_EVENT,e),this},ximpel.View.prototype.onDetach=function(e){return this.pubSub.subscribe(this.DETACH_EVENT,e),this},ximpel.View.prototype.setElement=function(e){return this.$el=e instanceof Jquery?e:$(e),this},ximpel.Model=function(){},ximpel.Model.prototype.get=function(e){return this[e]},ximpel.Model.prototype.set=function(e,t){return this[e]=t,this},ximpel.PlaylistModel=function(){this.subjectModels={},this.mediaList=[],this.firstSubjectToPlay="",this.variableModifiers=[]},ximpel.PlaylistModel.prototype=new ximpel.Model,ximpel.SubjectModel=function(){this.variableModifiers=[],this.sequenceModel=null,this.leadsToList=[],this.swipeTo={}},ximpel.SubjectModel.prototype=new ximpel.Model,ximpel.SubjectModel.prototype.description="",ximpel.SubjectModel.prototype.subjectId="",ximpel.SubjectModel.prototype.getId=function(){return this.subjectId},ximpel.SequenceModel=function(){this.list=[]},ximpel.SequenceModel.prototype=new ximpel.Model,ximpel.SequenceModel.prototype.ORDER_DEFAULT="default",ximpel.SequenceModel.prototype.ORDER_RANDOM="random",ximpel.SequenceModel.prototype.order=ximpel.SequenceModel.prototype.ORDER_DEFAULT,ximpel.SequenceModel.prototype.add=function(e){this.list.push(e)},ximpel.ParallelModel=function(){this.list=[]},ximpel.ParallelModel.prototype=new ximpel.Model,ximpel.ParallelModel.prototype.add=function(e){this.list.push(e)},ximpel.MediaModel=function(){this.overlays=[],this.questionLists=[],this.customAttributes={},this.customElements=[],this.leadsToList=[],this.variableModifiers=[]},ximpel.MediaModel.prototype=new ximpel.Model,ximpel.MediaModel.prototype.description="",ximpel.MediaModel.prototype.mediaType=null,ximpel.MediaModel.prototype.duration=0,ximpel.MediaModel.prototype.repeat=!1,ximpel.MediaModel.prototype.mediaId=null,ximpel.MediaModel.prototype.getId=function(){return this.mediaId},ximpel.QuestionListModel=function(){this.startTime=0,this.questionTimeLimit=0,this.questions=[]},ximpel.QuestionListModel.prototype=new ximpel.Model,ximpel.QuestionModel=function(){this.type="boolean",this.startTime=0,this.timeLimit=null,this.questionText="",this.answer=!0,this.options=[],this.variableModifiers=[]},ximpel.QuestionModel.prototype=new ximpel.Model,ximpel.QuestionOptionModel=function(){this.optionName="",this.optionText=""},ximpel.QuestionOptionModel.prototype=new ximpel.Model,ximpel.VariableModifierModel=function(){},ximpel.VariableModifierModel.prototype=new ximpel.Model,ximpel.VariableModifierModel.prototype.OPERATION_SET="set",ximpel.VariableModifierModel.prototype.OPERATION_ADD="add",ximpel.VariableModifierModel.prototype.OPERATION_SUBSTRACT="substract",ximpel.VariableModifierModel.prototype.OPERATION_MULTIPLY="multiply",ximpel.VariableModifierModel.prototype.OPERATION_DIVIDE="divide",ximpel.VariableModifierModel.prototype.OPERATION_POWER="power",ximpel.VariableModifierModel.prototype.id="",ximpel.VariableModifierModel.prototype.operation="set",ximpel.VariableModifierModel.prototype.value=0,ximpel.ConditionModel=function(){},ximpel.ConditionModel.prototype=new ximpel.Model,ximpel.ConditionModel.prototype.condition=null,ximpel.LeadsToModel=function(){},ximpel.LeadsToModel.prototype=new ximpel.Model,ximpel.LeadsToModel.prototype.subject=null,ximpel.LeadsToModel.prototype.conditionModel=null,ximpel.OverlayModel=function(){this.variableModifiers=[],this.leadsToList=[]},ximpel.OverlayModel.prototype=new ximpel.Model,ximpel.OverlayModel.prototype.SHAPE_RECTANGLE="rectangle",ximpel.OverlayModel.prototype.x=0,ximpel.OverlayModel.prototype.y=0,ximpel.OverlayModel.prototype.waitForMediaComplete=!1,ximpel.OverlayModel.prototype.leadsTo=null,ximpel.OverlayModel.prototype.startTime=0,ximpel.OverlayModel.prototype.duration=0,ximpel.OverlayModel.prototype.text="",ximpel.OverlayModel.prototype.shape="rectangle",ximpel.OverlayModel.prototype.width="200px",ximpel.OverlayModel.prototype.height="100px",ximpel.OverlayModel.prototype.side="150px",ximpel.OverlayModel.prototype.diameter="150px",ximpel.OverlayModel.prototype.textAlign="center",ximpel.OverlayModel.prototype.opacity=.4,ximpel.OverlayModel.prototype.hoverOpacity=.6,ximpel.OverlayModel.prototype.backgroundColor="white",ximpel.OverlayModel.prototype.hoverBackgroundColor=null,ximpel.OverlayModel.prototype.textColor="white",ximpel.OverlayModel.prototype.hoverTextColor=null,ximpel.OverlayModel.prototype.fontFamily="Arial",ximpel.OverlayModel.prototype.hoverFontFamily=null,ximpel.OverlayModel.prototype.fontSize="50px",ximpel.OverlayModel.prototype.hoverFontSize=null,ximpel.OverlayModel.prototype.backgroundImage=null,ximpel.OverlayModel.prototype.description=null,ximpel.ConfigModel=function(){},ximpel.ConfigModel.prototype=new ximpel.Model,ximpel.ConfigModel.prototype.mediaDirectory="",ximpel.ConfigModel.prototype.titleScreenImage="assets/ximpel_title_screen.png",ximpel.ConfigModel.prototype.enableControls=!0,ximpel.ConfigModel.prototype.controlsDisplayMethod="overlay",ximpel.ConfigModel.prototype.showScore=!1,ximpel.ConfigModel.prototype.minimumSwipeVelocity=.1,ximpel.ConfigModel.prototype.minimumSwipeTranslation=50,ximpel.ConfigModel.prototype.extend=function(e){Object.getOwnPropertyNames(e).forEach(function(t){this[t]=e[t]},this)},ximpel.CustomElementModel=function(e,t){this.elementName=e||"",this.elementAttributes=t||{}},ximpel.XimpelAppModel=function(){this.initialAppWidth="1080px",this.initialAppHeight="720px",this.$appElement=null,this.$parentElement=null,this.playlistFile=null,this.configFile=null,this.ximpelPlayer=null,this.parser=null,this.configModel=new ximpel.ConfigModel,this.playlistModel=null,this.playlistXmlDocument=null,this.configXmlDocument=null,this.filesRequestPromise=null,this.playlistRequestPromise=null,this.configRequestPromise=0,this.appReadyState=null,this.playerState=null},ximpel.XimpelAppModel.prototype=new ximpel.Model,ximpel.XimpelAppModel.prototype.PLAYER_STATE_PLAYING="player_state_playing",ximpel.XimpelAppModel.prototype.PLAYER_STATE_PAUSED="player_state_paused",ximpel.XimpelAppModel.prototype.PLAYER_STATE_STOPPED="player_state_stopped",ximpel.XimpelApp=function(e,t,i,s){var s=s||{},o=this.ximpelAppModel=new ximpel.XimpelAppModel;o.$parentElement=ximpel.getElement(s.parentElement)||o.$parentElement,o.appId=e,this.ximpelAppView=new ximpel.XimpelAppView(o,s.appElement,s.appWidth,s.appHeight),this.ximpelPlayer=null,this.parser=new ximpel.Parser,o.playlistFile=t,o.configFile=i,o.playlistXmlDocument=null,o.configXmlDocument=null,o.configModel=null,o.playlistModel=null,o.filesRequestPromise=null,o.playlistRequestPromise=null,o.configRequestPromise=null,o.hideControlsTimeoutHandler=null,o.hideCursorTimeoutHandler=null,o.appReadyState=this.APP_STATE_LOADING,o.playerState=this.ximpelAppModel.PLAYER_STATE_STOPPED},ximpel.XimpelApp.prototype.load=function(e){var t=this.ximpelAppModel,i=!1!==(e=e||{}).autoPlay;return t.filesRequestPromise=this.loadFiles(t.playlistFile,t.configFile),t.filesRequestPromise.done(function(e,s){t.playlistXmlDocument=e[0],t.configXmlDocument=s?s[0]:null;var o=this.parse(t.playlistXmlDocument,t.configXmlDocument);if(!o)return ximpel.error("XimelApp.load(): No XIMPEL player was created because the playlist or config file was invalid."),!1;t.playlistModel=o.playlist,t.configModel=o.config,this.ximpelPlayer=new ximpel.Player(this.getPlayerElement(),o.playlist,o.config),this.ximpelAppModel.appReadyState=this.ximpelAppModel.APP_READY_STATE_READY,this.ximpelAppView.registerPlayHandler(this.startPlayer.bind(this)),this.ximpelAppView.registerPauseHandler(this.pausePlayer.bind(this)),this.ximpelAppView.registerStopHandler(this.stopPlayer.bind(this)),this.ximpelAppView.render(t.$parentElement),!0===i&&this.startPlayer()}.bind(this)),t.filesRequestPromise},ximpel.XimpelApp.prototype.loadFiles=function(e,t,i){var s=this.ximpelAppModel;return s.playlistRequestPromise=this.requestXmlFile(e).fail(function(t,i,s){ximpel.error("XimpelApp.loadFiles(): Failed to load the playlist file ("+e+") from the server or the XML syntax is invalid (HTTP status='"+t.status+" "+t.statusText+"', message='"+i+"')")}.bind(this)),t&&(s.configRequestPromise=this.requestXmlFile(t).fail(function(e,i,s){ximpel.error("XimpelApp.loadFiles(): Failed to load the config file ("+t+") from the server or the XML syntax is invalid! (HTTP status='"+e.status+" "+e.statusText+"', message='"+i+"')")}.bind(this))),$.when(s.playlistRequestPromise,s.configRequestPromise)},ximpel.XimpelApp.prototype.requestXmlFile=function(e,t){return $.ajax({type:"GET",url:e,dataType:"xml",cache:!1})},ximpel.XimpelApp.prototype.parse=function(e,t){this.ximpelAppModel;var i=this.parser.parse(e,t),s=i.playlist||null,o=i.config||null;return s&&o?i:(ximpel.error("XimpelApp.parse(): Failed to parse playlist or config document."),!1)},ximpel.XimpelApp.prototype.getPlayerElement=function(){return this.ximpelAppView.getPlayerElement()},ximpel.XimpelApp.prototype.startPlayer=function(){this.ximpelAppModel.appReadyState===this.ximpelAppModel.APP_READY_STATE_READY?this.ximpelAppModel.playerState===this.ximpelAppModel.PLAYER_STATE_PAUSED||this.ximpelAppModel.playerState===this.ximpelAppModel.PLAYER_STATE_STOPPED?(this.ximpelAppModel.playerState=this.ximpelAppModel.PLAYER_STATE_PLAYING,this.ximpelPlayer.play(),this.ximpelAppView.renderControls()):ximpel.warn("XimpelApp.startPlayer(): cannot start player when the player is not paused or stopped."):ximpel.warn("XimpelApp.startPlayer(): XimpelApp.startPlayer(): cannot start player when app is not ready yet.")},ximpel.XimpelApp.prototype.pausePlayer=function(){if(this.ximpelAppModel.appReadyState===this.ximpelAppModel.APP_READY_STATE_READY){if(this.ximpelAppModel.playerState===this.ximpelAppModel.PLAYER_STATE_PLAYING)this.ximpelAppModel.playerState=this.ximpelAppModel.PLAYER_STATE_PAUSED,this.ximpelPlayer.pause();else{if(this.ximpelAppModel.playerState!==this.ximpelAppModel.PLAYER_STATE_PAUSED)return void ximpel.warn("XimpelApp.pausePlayer(): cannot pause player when the player is stopped.");ximpel.warn("XimpelApp.pausePlayer(): cannot pause player when the player is already paused.")}this.ximpelAppView.renderControls()}else ximpel.warn("XimpelApp.pausePlayer(): cannot pause player when app is not ready yet.")},ximpel.XimpelApp.prototype.stopPlayer=function(){this.ximpelAppModel.appReadyState===this.ximpelAppModel.APP_READY_STATE_READY?this.ximpelAppModel.playerState===this.ximpelAppModel.PLAYER_STATE_PLAYING||this.ximpelAppModel.playerState===this.ximpelAppModel.PLAYER_STATE_PAUSED?(this.ximpelAppModel.playerState=this.ximpelAppModel.PLAYER_STATE_STOPPED,this.ximpelPlayer.stop(),this.ximpelAppView.renderControls()):ximpel.warn("XimpelApp.stopPlayer(): cannot stop player when the player is already stopped."):ximpel.warn("XimpelApp.stopPlayer(): cannot stop player when app is not ready yet.")},ximpel.XimpelApp.prototype.getAppElementWidth=function(){this.ximpelAppModel.$appElement.width()},ximpel.XimpelApp.prototype.getAppElementHeight=function(){this.ximpelAppModel.$appElement.height()},ximpel.Player=function(e,t,i){this.$playerElement=ximpel.wrapInJquery(e),this.playlistModel=t,this.configModel=i,this.subjectModels=t.subjectModels,this.firstSubjectModel=this.getFirstSubjectModel(),this.availableMediaTypes=ximpel.availableMediaTypes,this.mediaItems={},this.currentSubjectModel=null,this.pubSub=new ximpel.PubSub,this.variables=[],this.state=this.STATE_STOPPED,this.sequencePlayer=new ximpel.SequencePlayer(this),this.sequencePlayer.addEventHandler(this.sequencePlayer.EVENT_SEQUENCE_END,this.handleSequencePlayerEnd.bind(this)),"undefined"==typeof Hammer?ximpel.warn("Hammer is not loaded. Swipe events will not be supported."):(this.mc=new Hammer.Manager(this.$playerElement[0]),this.mc.add(new Hammer.Pan),this.mc.on("pan",this.onPan.bind(this))),this.init()},ximpel.Player.prototype.STATE_PLAYING="state_player_playing",ximpel.Player.prototype.STATE_PAUSED="state_player_paused",ximpel.Player.prototype.STATE_STOPPED="state_player_stopped",ximpel.Player.prototype.EVENT_PLAYER_END="ended",ximpel.Player.prototype.EVENT_VARIABLE_UPDATED="variable_updated",ximpel.Player.prototype.EVENT_SWIPE="swipe",ximpel.Player.prototype.EVENT_SUBJECT_PLAYING="subject_playing",ximpel.Player.prototype.init=function(){return this.constructMediaItems(),this.applyVariableModifiers(this.playlistModel.variableModifiers),this},ximpel.Player.prototype.reset=function(e){this.state=this.STATE_STOPPED,this.currentSubjectModel=null,this.sequencePlayer.stop(),this.variables=[],this.applyVariableModifiers(this.playlistModel.variableModifiers),e&&this.clearEventHandlers()},ximpel.Player.prototype.play=function(){return this.isPlaying()?(ximpel.warn("Player.play(): play() called while already playing."),this):this.isPaused()?(this.resume(),this):(this.state=this.STATE_PLAYING,this.playSubject(this.firstSubjectModel),this)},ximpel.Player.prototype.playSubject=function(e){this.currentSubjectModel=e;var t=e.sequenceModel;this.applyVariableModifiers(e.variableModifiers),this.sequencePlayer.play(t),this.pubSub.publish(this.EVENT_SUBJECT_PLAYING,e)},ximpel.Player.prototype.resume=function(){return this.isPaused()?(this.state=this.STATE_PLAYING,this.sequencePlayer.resume(),this):(ximpel.warn("Player.resume(): resume() called while not in a paused state."),this)},ximpel.Player.prototype.pause=function(){return this.isPlaying()?(this.state=this.STATE_PAUSED,this.sequencePlayer.pause(),this):(ximpel.warn("Player.pause(): pause() called while not in a playing state."),this)},ximpel.Player.prototype.stop=function(){return this.isStopped()?(ximpel.warn("Player.stop(): stop() called while already in a stopped state."),this):(this.state=this.STATE_STOPPED,this.reset(),this)},ximpel.Player.prototype.goTo=function(e){var t=this.subjectModels[e];{if(t)return this.playSubject(t),this;ximpel.warn("Player.goTo(): Cannot play a subject with subjectId '"+e+"'. There is no subject with that id.")}},ximpel.Player.prototype.getVariable=function(e){return this.variables[e]},ximpel.Player.prototype.applyVariableModifiers=function(e){$.each(e,function(t,i){var s=e[t];this.applyVariableModifier(s)}.bind(this))},ximpel.Player.prototype.applyVariableModifier=function(e){var t=this.variables[e.id];switch(void 0===t&&(this.variables[e.id]=0,t=0),e.operation){case e.OPERATION_SET:i=e.value;break;case e.OPERATION_ADD:i=NaN===Number(t)?0:Number(t);i+=Number(e.value);break;case e.OPERATION_SUBSTRACT:i=NaN===Number(t)?0:Number(t);i-=Number(e.value);break;case e.OPERATION_MULTIPLY:i=NaN===Number(t)?0:Number(t);i*=Number(e.value);break;case e.OPERATION_DIVIDE:i=NaN===Number(t)?0:Number(t);i/=Number(e.value);break;case e.OPERATION_POWER:i=NaN===Number(t)?0:Number(t);i=Number(Math.pow(i,e.value));break;default:var i=t}this.variables[e.id]=i,this.pubSub.publish(this.EVENT_VARIABLE_UPDATED,e.id)},ximpel.Player.prototype.isPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.Player.prototype.isPaused=function(){return this.state===this.STATE_PAUSED},ximpel.Player.prototype.isStopped=function(){return this.state===this.STATE_STOPPED},ximpel.Player.prototype.determineLeadsTo=function(e){for(var t=null,i=0;i<e.length;i++){var s=e[i];if(s.conditionModel){if(this.evaluateCondition(s.conditionModel))return s.subject}else t=s.subject}return t},ximpel.Player.prototype.evaluateCondition=function(conditionModel){for(var condition=conditionModel.condition,parsedCondition=condition,regex=/\{\{(\w+)\}\}/g,variableNames=[],variableNamesTemplated=[];match=regex.exec(condition);)variableNames.push(match[1]),variableNamesTemplated.push("{{"+match[1]+"}}");for(var variableValues=[],i=0;i<variableNames.length;i++){var variableName=variableNames[i];variableValues[i]=this.variables[variableName]}var failedToTemplateCondition=!1;if($.each(variableNamesTemplated,function(e,t){void 0!==variableValues[e]&&null!==variableValues[e]?parsedCondition=parsedCondition.replace(t,variableValues[e]):failedToTemplateCondition=!0}),!0===failedToTemplateCondition)return!1;var result=eval(parsedCondition);return(!0===result||!1===result)&&result},ximpel.Player.prototype.determineNextSubjectToPlay=function(){return this.determineLeadsTo(this.currentSubjectModel.leadsToList)},ximpel.Player.prototype.handleSequencePlayerEnd=function(){var e=this.determineNextSubjectToPlay();e&&this.goTo(e),this.pubSub.publish(this.EVENT_PLAYER_END)},ximpel.Player.prototype.getFirstSubjectModel=function(){return this.playlistModel.subjectModels[this.playlistModel.firstSubjectToPlay]},ximpel.Player.prototype.addEventHandler=function(e,t){switch(e){case this.EVENT_PLAYER_END:return this.pubSub.subscribe(this.EVENT_PLAYER_END,t);case this.EVENT_VARIABLE_UPDATED:return this.pubSub.subscribe(this.EVENT_VARIABLE_UPDATED,t);case this.EVENT_SUBJECT_PLAYING:return this.pubSub.subscribe(this.EVENT_SUBJECT_PLAYING,t);case this.EVENT_SWIPE:return this.pubSub.subscribe(this.EVENT_SWIPE,t);default:ximpel.warn("Player.addEventHandler(): cannot add an event handler for event '"+e+"'. This event is not used by the player.")}},ximpel.Player.prototype.clearEventHandlers=function(e){return this.pubSub.reset(),this},ximpel.Player.prototype.clearEventHandler=function(e,t){this.pubSub.unsubscribe(e,t)},ximpel.Player.prototype.constructMediaItems=function(){return this.getMediaModels().forEach(function(e){var t=new this.availableMediaTypes[e.mediaType].mediaTypeConstructor(e.customElements,e.customAttributes,this.$playerElement,this);this.mediaItems[e.mediaId]=t}.bind(this)),this},ximpel.Player.prototype.getPlayerElement=function(){return this.$playerElement},ximpel.Player.prototype.getMediaModels=function(){return this.playlistModel.mediaList},ximpel.Player.prototype.getConfigProperty=function(e){var t=this.configModel[e];return void 0!==t?t:null},ximpel.Player.prototype.onPan=function(e){if(!this.isPlaying()||!this.currentSubjectModel)return ximpel.warn("Player.onPan(): Ignoring event while stopped or paused"),this;var t=this.$playerElement[0].getBoundingClientRect(),i=t.width/this.$playerElement[0].offsetWidth,s=t.height/this.$playerElement[0].offsetHeight,o=e.deltaX/i,r=e.deltaY/s,n=o>0?"swiperight":"swipeleft",l=r>0?"swipedown":"swipeup";if(this.currentSubjectModel.swipeTo[n]||this.currentSubjectModel.swipeTo[l]){var a=this.currentSubjectModel.swipeTo[n]&&this.currentSubjectModel.swipeTo[l]&&Math.abs(o)>Math.abs(r)||!this.currentSubjectModel.swipeTo[l]?Hammer.DIRECTION_HORIZONTAL:Hammer.DIRECTION_VERTICAL,p=a==Hammer.DIRECTION_HORIZONTAL?o:r,u=1-Math.min(1,.0015*Math.abs(p)),d=1-Math.min(.4,1e-4*Math.abs(p)),h=a==Hammer.DIRECTION_HORIZONTAL?n:l,m=this.currentSubjectModel.swipeTo[h];if(a==Hammer.DIRECTION_HORIZONTAL?this.$playerElement.css("transform","translateX("+p+"px) scale("+d+")"):this.$playerElement.css("transform","translateY("+p+"px) scale("+d+")"),this.$playerElement.css("animation",""),this.$playerElement.css("opacity",u),e.isFinal)if(Math.abs(e.velocity)<this.getConfigProperty("minimumSwipeVelocity")||Math.abs(p)<this.getConfigProperty("minimumSwipeTranslation"))this.$playerElement.css("animation","swipe 0.5s ease-out forwards");else{if(a==Hammer.DIRECTION_HORIZONTAL){y=.8*this.$playerElement.width()*(o>0?-1:1);this.$playerElement.css("transform","translateX("+y+"px) scale(0.5)")}else{var y=.8*this.$playerElement.height()*(r>0?-1:1);this.$playerElement.css("transform","translateY("+y+"px) scale(0.5)")}this.$playerElement.css("animation","swipe 0.5s ease-out forwards"),this.goTo(m.subject),e.type=h,e.nextSubject=m,this.pubSub.publish(this.EVENT_SWIPE,e)}}},ximpel.Parser=function(){this.mediaTypeRegistrations=ximpel.availableMediaTypes,this.registeredMediaTags=Object.getOwnPropertyNames(this.mediaTypeRegistrations),this.validChildren={ximpel:["playlist","config"],playlist:["subject","score"],subject:["description","media","score","sequence","parallel"],media:["parallel","sequence"].concat(this.registeredMediaTags),parallel:["sequence"].concat(this.registeredMediaTags),sequence:["parallel"].concat(this.registeredMediaTags),overlay:["score"],score:[""],question:[""],description:[""],config:[""],__MEDIA_TYPE__:["overlay","score","question"]},this.mediaIdCounter=1},ximpel.Parser.prototype.parse=function(e,t){var i=this.parseXml(e),s=i.playlist||null,o=i.config;if(!s)return ximpel.error("Parser.parser(): Failed to parse the playlist file. The playlist file is invalid."),!1;if(t){if(!(r=this.parseXml(t).config||null))return ximpel.error("Parser.parse(): Failed to parse the config file. The config file is invalid."),!1}else var r=new ximpel.ConfigModel;return o&&r.extend(o),{playlist:s,config:r}},ximpel.Parser.prototype.parseXml=function(e){var t=e.childNodes[0];return t?"ximpel"!==t.nodeName?(ximpel.error("Parser.parseXML(): Invalid document specified. The Root element must be the <ximpel> element."),null):this.processXimpelNode(t):(ximpel.error("Parser.parseXml(): Cannot parse the XML contents, the given XML document is empty"),null)},ximpel.Parser.prototype.processXimpelNode=function(e){for(var t=this.getDomElementInfo(e),i={},s=0;s<t.nrOfChildElements;s++){var o=t.childElements[s];"playlist"===o.nodeName?i.playlist=this.processPlaylistNode(o):"config"===o.nodeName?i.config=this.processConfigNode(o):ximpel.warn("Parser.processXimpelNode(): Invalid child ignored! Element <"+t.tagName+"> has child <"+o.nodeName+">. Allowed children: "+this.validChildren[t.tagName].toString()+".")}return i},ximpel.Parser.prototype.processPlaylistNode=function(e){for(var t=this.getDomElementInfo(e),i=null,s=new ximpel.PlaylistModel,o=0;o<t.nrOfChildElements;o++){var r=t.childElements[o];if("subject"===r.nodeName){var n=this.processSubjectNode(s,r);s.subjectModels[n.subjectId]=n,null===i&&(i=n.subjectId)}else if("score"===r.nodeName||"variable"===r.nodeName){var l=this.processVariableNode(s,r);s.variableModifiers.push(l)}else ximpel.warn("Parser.processPlaylistNode(): Invalid child ignored! Element <"+t.tagName+"> has child <"+r.nodeName+">. Allowed children: "+this.validChildren[t.tagName].toString()+".")}return s.firstSubjectToPlay=i,s},ximpel.Parser.prototype.processSubjectNode=function(e,t){for(var i=this.getDomElementInfo(t),s=new ximpel.SubjectModel,o=0;o<i.nrOfAttributes;o++){var r=i.attributes[o].name,n=i.attributes[o].value;"id"===r?s.subjectId=n:"leadsTo"===r?((u=new ximpel.LeadsToModel).subject=n,s.leadsToList.push(u)):"swipeLeftTo"===r?((u=new ximpel.LeadsToModel).subject=n,s.swipeTo.swipeleft=u):"swipeRightTo"===r?((u=new ximpel.LeadsToModel).subject=n,s.swipeTo.swiperight=u):"swipeUpTo"===r?((u=new ximpel.LeadsToModel).subject=n,s.swipeTo.swipeup=u):"swipeDownTo"===r?((u=new ximpel.LeadsToModel).subject=n,s.swipeTo.swipedown=u):ximpel.warn("Parser.processSubjectNode(): Invalid attribute ignored! Attribute '"+r+"' on element <"+i.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(o=0;o<i.nrOfChildElements;o++){var l=i.childElements[o],a=l.nodeName;if("description"===a)s.description=this.processDescriptionNode(e,l);else if("media"===a)s.sequenceModel=this.processMediaNode(e,l);else if("score"===a||"variable"===a){var p=this.processVariableNode(e,l);s.variableModifiers.push(p)}else if("leadsTo"===a){var u=this.processLeadsToNode(e,l);s.leadsToList.push(u)}else ximpel.warn("Parser.processSubjectNode(): Invalid child ignored! Element <"+i.tagName+"> has child <"+a+">. Allowed children: "+this.validChildren[i.tagName].toString()+".")}return s},ximpel.Parser.prototype.processMediaNode=function(e,t){return this.processSequenceNode(e,t)},ximpel.Parser.prototype.processSequenceNode=function(e,t){for(var i=this.getDomElementInfo(t),s=new ximpel.SequenceModel,o=0;o<i.nrOfAttributes;o++){var r=i.attributes[o].name,n=i.attributes[o].value;"order"===r?s.order=n:ximpel.warn("Parser.processSequenceNode(): Invalid attribute ignored! Attribute '"+r+"' on element <"+i.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(o=0;o<i.nrOfChildElements;o++){var l=i.childElements[o],a=l.nodeName;$.inArray(a,this.registeredMediaTags)>-1?s.add(this.processMediaTypeNode(e,l)):"parallel"===a?s.add(this.processParallelNode(e,l)):"sequence"===a?s.add(this.processSequenceNode(e,l)):ximpel.warn("Parser.processSequenceNode(): Invalid child ignored! Element <"+i.tagName+"> has child <"+a+">. Allowed children: "+this.validChildren[i.tagName].toString()+".")}return s},ximpel.Parser.prototype.processParallelNode=function(e,t){for(var i=this.getDomElementInfo(t),s=new ximpel.ParallelModel,o=0;o<i.childElements;o++){var r=i.childElements[o],n=r.nodeName;$.inArray(n,this.registeredMediaTags)>-1?s.add(this.processMediaTypeNode(e,r)):"sequence"===n?s.add(this.processSequenceNode(e,r)):ximpel.warn("Parser.processParallelNode(): Invalid child ignored! Element <"+i.tagName+"> has child <"+n+">. Allowed children: "+this.validChildren[i.tagName].toString()+".")}return s},ximpel.Parser.prototype.processMediaTypeNode=function(e,t){var i=this.getDomElementInfo(t),s=new ximpel.MediaModel;s.mediaType=i.tagName;for(n=0;n<i.nrOfAttributes;n++){var o=i.attributes[n].name,r=i.attributes[n].value;"leadsTo"===o?((u=new ximpel.LeadsToModel).subject=r,s.leadsToList.push(u)):"duration"===o?s.duration=1e3*parseFloat(r):"repeat"===o?s.repeat="true"===r:s.customAttributes[o]=r}for(var n=0;n<i.nrOfChildElements;n++){var l=i.childElements[n],a=l.nodeName;if("overlay"===a)s.overlays.push(this.processOverlayNode(e,l,n));else if("score"===a||"variable"===a){var p=this.processVariableNode(e,l);s.variableModifiers.push(p)}else if("question"===a)s.questionLists.push(this.processQuestionNode(e,l));else if("questions"===a)s.questionLists.push(this.processQuestionsNode(e,l));else if("leadsTo"===a){var u=this.processLeadsToNode(e,l);s.leadsToList.push(u)}else{for(var d={},h=0;h<l.attributes.length;h++)d[l.attributes[h].name]=l.attributes[h].value;var m=new ximpel.CustomElementModel(a,d);s.customElements.push(m)}}return s.mediaId=this.mediaIdCounter++,e.mediaList.push(s),s},ximpel.Parser.prototype.processQuestionsNode=function(e,t){for(var i=this.getDomElementInfo(t),s=new ximpel.QuestionListModel,o=0;o<i.nrOfAttributes;o++){var r=i.attributes[o].name,n=i.attributes[o].value;"startTime"===r?s.startTime=1e3*parseFloat(n):"questionTimeLimit"===r?s.questionTimeLimit=1e3*parseFloat(n):"nrOfQuestionsToAsk"===r?s.nrOfQuestionsToAsk=parseInt(n):"questionOrder"===r?s.questionOrder=n:ximpel.warn("Parser.processQuestionsNode(): Invalid attribute ignored! Attribute '"+r+"' on element <"+i.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(o=0;o<i.nrOfChildElements;o++){var l=i.childElements[o],a=l.nodeName;"question"===a?s.questions.push(this.processQuestionNode(e,l)):ximpel.warn("Parser.processQuestionsNode(): Invalid child ignored! Element <"+i.tagName+"> has child <"+a+">. Allowed children: "+this.validChildren[i.tagName].toString()+".")}return s},ximpel.Parser.prototype.processQuestionNode=function(e,t){for(var i=this.getDomElementInfo(t),s=new ximpel.QuestionModel,o="questions"===t.parentNode.nodeName,r=0;r<i.nrOfAttributes;r++){var n=i.attributes[r].name,l=i.attributes[r].value;"startTime"===n&&!1===o?s.startTime=1e3*parseFloat(l):"questionTimeLimit"===n?s.questionTimeLimit=1e3*parseFloat(l):"answer"===n?s.answer=l:ximpel.warn("Parser.processQuestionNode(): Invalid attribute ignored! Attribute '"+n+"' on element <"+i.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(var a="",r=0;r<t.childNodes.length;r++)3===t.childNodes[r].nodeType&&(a+=t.childNodes[r].nodeValue);s.questionText=$.trim(a);for(var p=0,r=0;r<i.nrOfChildElements;r++){var u=i.childElements[r],d=u.nodeName;if("option"===d){p+=1;var h=this.processOptionNode(e,u);h.optionName=""===h.optionName?""+p:h.optionName,s.options.push(h)}else if("score"===d||"variable"===d){var m=this.processVariableNode(e,u);s.variableModifiers.push(m)}else ximpel.warn("Parser.processQuestionNode(): Invalid child ignored! Element <"+i.tagName+"> has child <"+d+">. Allowed children: "+this.validChildren[i.tagName].toString()+".")}if(s.options.length<=0){var y=new ximpel.QuestionOptionModel;y.optionName="true",y.optionText="True";var c=new ximpel.QuestionOptionModel;c.optionName="false",c.optionText="False",s.options.push(y),s.options.push(c)}if(!o){var T=new ximpel.QuestionListModel;return T.startTime=s.startTime||0,T.questions.push(s),T}return s},ximpel.Parser.prototype.processOptionNode=function(e,t){for(var i=this.getDomElementInfo(t),s=new ximpel.QuestionOptionModel,o=0;o<i.nrOfAttributes;o++){var r=i.attributes[o].name,n=i.attributes[o].value;"name"===r&&(s.optionName=n),ximpel.warn("Parser.processOptionNode(): Invalid attribute ignored! Attribute '"+r+"' on element <"+i.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(var l="",o=0;o<t.childNodes.length;o++)3===t.childNodes[o].nodeType&&(l+=t.childNodes[o].nodeValue);return s.optionText=$.trim(l),s},ximpel.Parser.prototype.processVariableNode=function(e,t){for(var i=this.getDomElementInfo(t),s=new ximpel.VariableModifierModel,o=0;o<i.nrOfAttributes;o++){var r=i.attributes[o].name,n=i.attributes[o].value;"id"===r?s.id=n:"operation"===r?s.operation=n:"value"===r?s.value=n:ximpel.warn("Parser.processVariableNode(): Invalid attribute ignored! Attribute '"+r+"' on element <"+i.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(o=0;o<i.nrOfChildElements;o++){var l=i.childElements[o].nodeName;ximpel.warn("Parser.processVariableNode(): Invalid child ignored! Element <"+i.tagName+"> has child <"+l+">. No children allowed on <"+i.tagName+">.")}return s},ximpel.Parser.prototype.processLeadsToNode=function(e,t){for(var i=this.getDomElementInfo(t),s=new ximpel.LeadsToModel,o=0;o<i.nrOfAttributes;o++){var r=i.attributes[o].name,n=i.attributes[o].value;if("condition"===r)var l=n;else"subject"===r?s.subject=n:ximpel.warn("Parser.processLeadsToNode(): Invalid attribute ignored! Attribute '"+r+"' on element <"+i.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}if(l){var a=new ximpel.ConditionModel;a.condition=l||null,s.conditionModel=a}else s.conditionModel=null;return s},ximpel.Parser.prototype.processDescriptionNode=function(e,t){var i=this.getDomElementInfo(t),s=t.childNodes[0],o="";return s?3===s.nodeType?o=$.trim(s.nodeValue):ximpel.warn("Parser.processDescriptionNode(): Invalid description! Element <"+i.tagName+"> has an invalid child node. Only text is allowed inside the <description> element."):o="",o},ximpel.Parser.prototype.processOverlayNode=function(e,t,i){var s=this.getDomElementInfo(t),o=new ximpel.OverlayModel;o.index=i;for(l=0;l<s.nrOfAttributes;l++){var r=s.attributes[l].name,n=s.attributes[l].value;"x"===r?o.x=parseInt(n):"y"===r?o.y=parseInt(n):"shape"===r?o.shape=n:"width"===r?o.width=parseInt(n):"height"===r?o.height=parseInt(n):"side"===r?o.side=parseInt(n):"diameter"===r?o.diameter=parseInt(n):"leadsTo"===r?((d=new ximpel.LeadsToModel).subject=n,o.leadsToList.push(d)):"startTime"===r?o.startTime=1e3*parseFloat(n):"duration"===r?o.duration=1e3*parseFloat(n):"text"===r?o.text=n:"alpha"===r?o.opacity=n:"hoverAlpha"===r?o.hoverOpacity=n:"backgroundColor"===r?o.backgroundColor=n:"hoverBackgroundColor"===r?o.hoverBackgroundColor=n:"textColor"===r?o.textColor=n:"hoverTextColor"===r?o.hoverTextColor=n:"fontFamily"===r?o.fontFamily=n:"hoverFontFamily"===r?o.hoverFontFamily=n:"fontSize"===r?o.fontSize=n:"hoverFontSize"===r?o.hoverFontSize=n:"image"===r?o.backgroundImage=n:"hoverImage"===r?o.hoverBackgroundImage=n:"waitForMediaComplete"===r?o.waitForMediaComplete=n:"description"===r?o.description=n:ximpel.warn("Parser.processOverlayNode(): Invalid attribute ignored! Attribute '"+r+"' on element <"+s.tagName+"> is not supported. Make sure you spelled the attribute name correctly.")}for(var l=0;l<s.nrOfChildElements;l++){var a=s.childElements[l],p=a.nodeName;if("score"===p||"variable"===p){var u=this.processVariableNode(e,a);o.variableModifiers.push(u)}else if("leadsTo"===p){var d=this.processLeadsToNode(e,a);o.leadsToList.push(d)}else ximpel.warn("Parser.processOverlayNode(): Invalid child ignored! Element <"+s.tagName+"> has child <"+p+">. Allowed children: "+this.validChildren[s.tagName].toString()+".")}return o},ximpel.Parser.prototype.processConfigNode=function(e){for(var t=this.getDomElementInfo(e),i=new ximpel.ConfigModel,s=0;s<t.nrOfChildElements;s++){var o=t.childElements[s],r=o.nodeName;"enableControls"===r?i.enableControls="false"!==$.trim(o.textContent).toLowerCase():"controlsDisplayMethod"===r?i.controlsDisplayMethod=$.trim(o.textContent):"mediaDirectory"===r?i.mediaDirectory=$.trim(o.textContent):"showScore"===r?i.showScore="true"===$.trim(o.textContent).toLowerCase():"minimumSwipeVelocity"===r?i.minimumSwipeVelocity=parseFloat(o.textContent):"minimumSwipeTranslation"===r?i.minimumSwipeTranslation=parseFloat(o.textContent):ximpel.warn("Parser.processConfigNode(): Invalid child ignored! Element <"+t.tagName+"> has child <"+r+">.This child element is not allowed on <"+t.tagName+">.")}return i},ximpel.Parser.prototype.getChildElementNodes=function(e){if(e.children)return e.children;for(var t=e.childNodes.length,i=[],s=0;s<t;s++){var o=e.childNodes[s];1===o.nodeType&&i.push(o)}return i},ximpel.Parser.prototype.getDomElementInfo=function(e){var t={};return t.tagName=e.nodeName,t.attributes=e.attributes,t.nrOfAttributes=t.attributes.length,t.childElements=this.getChildElementNodes(e),t.nrOfChildElements=t.childElements.length,t},ximpel.MediaPlayer=function(e,t){this.player=e,this.$playerElement=e.getPlayerElement(),this.mediaModel=null,this.mediaItem=null,this.getPlayTime=null,this.overlaysSortedByStartTime=null,this.overlayIndexToStartNext=0,this.playingOverlays=[],this.mediaPlayerUpdateHandler=null,this.mediaHasEnded=!1,this.pubSub=new ximpel.PubSub,this.state=this.STATE_STOPPED,this.playMediaItemWhenMediaPlayerResumes=!1,this.playTimestamp=0,this.pauseTimestamp=0,this.totalPlayTime=0,this.mediaItemOnEndSubscriptionFunction=null,this.questionManager=null,t&&this.use(t,!0)},ximpel.MediaPlayer.prototype.MEDIA_PLAYER_UPDATE_INTERVAL=50,ximpel.MediaPlayer.prototype.EVENT_MEDIA_PLAYER_END="ended",ximpel.MediaPlayer.prototype.EVENT_IFRAME_OPEN="iframe_open",ximpel.MediaPlayer.prototype.EVENT_IFRAME_CLOSE="iframe_close",ximpel.MediaPlayer.prototype.STATE_PLAYING="state_mp_playing",ximpel.MediaPlayer.prototype.STATE_PAUSED="state_mp_paused",ximpel.MediaPlayer.prototype.STATE_STOPPED="state_mp_stopped",ximpel.MediaPlayer.prototype.use=function(e,t){t||this.reset(),this.mediaModel=e,this.mediaItem=this.player.mediaItems[e.mediaId],this.mediaItemOnEndSubscriptionFunction=this.mediaItem.addEventHandler("ended",this.handlePlaybackEnd.bind(this)),this.mediaItem.getPlayTime?this.getPlayTime=this.mediaItem.getPlayTime.bind(this.mediaItem):this.getPlayTime=this.getPlayTimeDefault,this.questionManager=new ximpel.QuestionManager(this.player,this.$playerElement,this.getPlayTime,e.questionLists),this.overlaysSortedByStartTime=this.getOverlaysSortedByStartTime(e.overlays)},ximpel.MediaPlayer.prototype.reset=function(e){this.mediaItem&&(this.mediaItem.removeEventHandler("ended",this.mediaItemOnEndSubscriptionFunction),this.mediaItem.stop()),this.questionManager&&(this.questionManager.stop(),this.questionManager=null),this.turnOffMediaPlayerUpdates(),this.destroyPlayingOverlays(),this.playingOverlays=[],this.overlayIndexToStartNext=0,this.resetPlayTime(),this.resetTotalPlayTime(),this.mediaHasEnded=!1,this.state=this.STATE_STOPPED,this.playMediaItemWhenMediaPlayerResumes=!1,this.mediaItemOnEndSubscriptionFunction=null,e&&this.clearEventHandlers()},ximpel.MediaPlayer.prototype.play=function(e){if(e&&this.use(e),this.mediaModel){if(this.isPlaying())return ximpel.warn("MediaPlayer.play(): play() called while already playing."),this;if(!this.isPaused())return this.state=this.STATE_PLAYING,this.mediaItem.play(),this.updatePlayTimeTracking(this.STATE_PLAYING),this.turnOnMediaPlayerUpdates(),this;this.resume()}else ximpel.error("MediaPlayer.play(): cannot start playing because no media model has been specified.")},ximpel.MediaPlayer.prototype.pause=function(){return this.isPaused()?(ximpel.warn("MediaPlayer.pause(): pause() called while already paused."),this):(this.state=this.STATE_PAUSED,this.mediaItem.isPlaying()?(this.playMediaItemWhenMediaPlayerResumes=!0,this.mediaItem.pause()):this.playMediaItemWhenMediaPlayerResumes=!1,this.updatePlayTimeTracking(this.STATE_PAUSED),this.turnOffMediaPlayerUpdates(),this)},ximpel.MediaPlayer.prototype.resume=function(){return this.isPaused()?(!0===this.playMediaItemWhenMediaPlayerResumes&&this.mediaItem.play(),this.state=this.STATE_PLAYING,this.updatePlayTimeTracking(this.STATE_PLAYING),this.turnOnMediaPlayerUpdates(),this):(ximpel.warn("MediaPlayer.resume(): resume() called while not paused."),this)},ximpel.MediaPlayer.prototype.stop=function(){return this.isStopped()?this:(this.updatePlayTimeTracking(this.STATE_STOPPED),this.reset(),this)},ximpel.MediaPlayer.prototype.updateMediaPlayer=function(){var e=this.getPlayTime();this.mediaHasEnded||this.updateOverlays(e),this.mediaHasEnded||this.questionManager.update(e),this.checkMediaItemDuration(e)},ximpel.MediaPlayer.prototype.updateOverlays=function(e){for(i=0;i<this.playingOverlays.length;i++)e>=(r=this.playingOverlays[i].endTime)&&0!==r&&(this.playingOverlays[i].view.destroy(),this.playingOverlays.splice(i,1),i--);for(var t=this.overlaysSortedByStartTime.length,i=this.overlayIndexToStartNext;i<t;i++){var s=this.overlaysSortedByStartTime[i];if(s.startTime>e||0===e)break;var o=new ximpel.OverlayView(s);o.render(this.$playerElement),o.onOneClick(this.handleOverlayClick.bind(this,s,o));var r=s.duration>0?s.startTime+s.duration:0;this.playingOverlays.push({view:o,model:s,endTime:r}),this.overlayIndexToStartNext++}},ximpel.MediaPlayer.prototype.handleOverlayClick=function(e,t){if(this.isPaused())return t.onOneClick(this.handleOverlayClick.bind(this,e,t)),void ximpel.warn("MediaPlayer.handleOverlayClick(): Cannot use overlays when in a paused state!");this.player.applyVariableModifiers(e.variableModifiers);var i=this.player.determineLeadsTo(e.leadsToList);if(i){if(0===i.toLowerCase().indexOf("url:")){this.isPlaying()&&(this.player.pause(),t.onOneClick(this.handleOverlayClick.bind(this,e,t)));var s=i.substr("url:".length);$player=this.player,$urlDisplay=$('<div class="urlDisplay"></div>'),$closeButton=$('<img class="closeButton" src="ximpel/images/close_button.png"/>').one("click",function(){this.pubSub.publish(this.EVENT_IFRAME_CLOSE,s),$urlDisplay.remove(),$player.isPaused()&&$player.resume()}.bind(this)),$urlDisplay.append($('<iframe src="'+s+'"></iframe>')).append($closeButton).appendTo(this.player.getPlayerElement()),this.pubSub.publish(this.EVENT_IFRAME_OPEN,s)}else this.player.goTo(i)}},ximpel.MediaPlayer.prototype.checkMediaItemDuration=function(e){var t=this.mediaModel.duration||0;e>=t&&0!==t&&this.handleDurationEnd()},ximpel.MediaPlayer.prototype.handleMediaEnd=function(){if(this.mediaHasEnded=!0,this.mediaModel.repeat)this.replayMediaItem();else{this.turnOffMediaPlayerUpdates(),this.mediaItem.pause();var e=this.player.determineLeadsTo(this.mediaModel.leadsToList);e?this.player.goTo(e):this.pubSub.publish(this.EVENT_MEDIA_PLAYER_END)}},ximpel.MediaPlayer.prototype.handlePlaybackEnd=function(){this.handleMediaEnd()},ximpel.MediaPlayer.prototype.handleDurationEnd=function(){this.handleMediaEnd()},ximpel.MediaPlayer.prototype.replayMediaItem=function(){this.totalPlayTime+=this.getPlayTime(),this.mediaItem.stop(),this.mediaItem.play()},ximpel.MediaPlayer.prototype.getTotalPlayTime=function(){return this.totalPlayTime+this.getPlayTime()},ximpel.MediaPlayer.prototype.updatePlayTimeTracking=function(e){if(e===this.STATE_PLAYING){var t=0===this.pauseTimestamp?0:Date.now()-this.pauseTimestamp;this.playTimestamp=0===this.playTimestamp?Date.now():this.playTimestamp+t,this.pauseTimestamp=0}else e===this.STATE_PAUSED?this.pauseTimestamp=0===this.pauseTimestamp?Date.now():this.pauseTimestamp:e===this.STATE_STOPPED&&(this.playTimestamp=0,this.pauseTimestamp=0)},ximpel.MediaPlayer.prototype.getPlayTimeDefault=function(){var e=Date.now(),t=0===this.pauseTimestamp?0:e-this.pauseTimestamp;return e-this.playTimestamp+t},ximpel.MediaPlayer.prototype.turnOnMediaPlayerUpdates=function(){this.mediaPlayerUpdateHandler=setTimeout(function(){this.turnOnMediaPlayerUpdates(),this.updateMediaPlayer()}.bind(this),this.MEDIA_PLAYER_UPDATE_INTERVAL)},ximpel.MediaPlayer.prototype.turnOffMediaPlayerUpdates=function(){this.mediaPlayerUpdateHandler&&clearTimeout(this.mediaPlayerUpdateHandler),this.mediaPlayerUpdateHandler=null},ximpel.MediaPlayer.prototype.destroyPlayingOverlays=function(){this.playingOverlays.forEach(function(e){e.view.destroy()}.bind(this))},ximpel.MediaPlayer.prototype.getOverlaysSortedByStartTime=function(e){return e.slice().sort(function(e,t){return e.startTime===t.startTime?e.index-t.index:e.startTime-t.startTime})},ximpel.MediaPlayer.prototype.addEventHandler=function(e,t){return this.pubSub.subscribe(e,t),this},ximpel.MediaPlayer.prototype.clearEventHandlers=function(e){return this.pubSub.reset(),this},ximpel.MediaPlayer.prototype.isPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.MediaPlayer.prototype.isPaused=function(){return this.state===this.STATE_PAUSED},ximpel.MediaPlayer.prototype.isStopped=function(){return this.state===this.STATE_STOPPED},ximpel.MediaPlayer.prototype.resetPlayTime=function(){this.pauseTimestamp=0,this.playTimestamp=0},ximpel.MediaPlayer.prototype.resetTotalPlayTime=function(){this.totalPlayTime=0},ximpel.QuestionManager=function(e,t,i,s){this.player=e,this.$el=t,this.getPlayTime=i,this.queuedQuestionLists=[],this.currentQuestionListModel=null,this.currentQuestion=null,this.questionListsSortedByStartTime=null,this.questionListIndexToQueueNext=0,this.questionIndexToStartNext=0,s&&this.use(s,!0)},ximpel.QuestionManager.prototype.use=function(e,t){t||this.reset(),this.questionListsSortedByStartTime=this.getQuestionListsSortedByStartTime(e)},ximpel.QuestionManager.prototype.reset=function(){this.currentQuestion&&this.currentQuestion.view.destroy(),this.queuedQuestionLists=[],this.currentQuestionListModel=null,this.questionListsSortedByStartTime=null,this.questionListIndexToQueueNext=0,this.currentQuestion=null,this.questionIndexToStartNext=0},ximpel.QuestionManager.prototype.update=function(e){if(this.checkForQuestionListsToQueue(e),this.currentQuestion&&this.currentQuestionListModel&&e>=this.currentQuestion.endAt&&0!==this.currentQuestion.endAt){var t=this.currentQuestion.view;!0!==t.isAnswered&&t.hideQuestion()}this.queuedQuestionLists.length>0&&!this.currentQuestionListModel&&e>0&&this.playNextQuestionListInQueue(e)},ximpel.QuestionManager.prototype.stop=function(){this.reset()},ximpel.QuestionManager.prototype.checkForQuestionListsToQueue=function(e){for(var t=this.questionListIndexToQueueNext;t<this.questionListsSortedByStartTime.length;t++){var i=this.questionListsSortedByStartTime[t];if(i.startTime>e)return;this.queuedQuestionLists.push(i),this.questionListIndexToQueueNext++}},ximpel.QuestionManager.prototype.playNextQuestionListInQueue=function(e){var t=this.queuedQuestionLists.shift();t&&(this.currentQuestionListModel=t,this.playQuestion(this.questionIndexToStartNext,e))},ximpel.QuestionManager.prototype.playQuestion=function(e,t){var i=this.currentQuestionListModel.questions[e],s=new ximpel.QuestionView(i),o=this.currentQuestionListModel.questionTimeLimit,r=i.questionTimeLimit,n=r||0===r?r:o,l=0===n?0:t+n;this.currentQuestion={index:e,model:i,view:s,endAt:l},this.questionIndexToStartNext=e+1,s.addEventHandler(s.EVENT_QUESTION_ENDED,this.handleQuestionAnswer.bind(this,i)),s.addEventHandler(s.EVENT_QUESTION_ENDED,this.nextQuestion.bind(this)),s.render(this.$el)},ximpel.QuestionManager.prototype.handleQuestionAnswer=function(e,t){e.answer===t&&this.player.applyVariableModifiers(e.variableModifiers)},ximpel.QuestionManager.prototype.nextQuestion=function(){this.currentQuestion.view.destroy(),this.currentQuestion=null,this.hasNextQuestion()?this.playQuestion(this.questionIndexToStartNext,this.getPlayTime()):this.stopQuestionList()},ximpel.QuestionManager.prototype.hasNextQuestion=function(){return!!this.currentQuestionListModel.questions[this.questionIndexToStartNext]},ximpel.QuestionManager.prototype.stopQuestionList=function(){this.questionIndexToStartNext=0,this.currentQuestionListModel=null},ximpel.QuestionManager.prototype.getQuestionListsSortedByStartTime=function(e){return e.slice().sort(function(e,t){return e.startTime-t.startTime})},ximpel.SequencePlayer=function(e,t){this.player=e,this.mediaPlayer=new ximpel.MediaPlayer(e),this.mediaPlayer.addEventHandler(this.mediaPlayer.EVENT_MEDIA_PLAYER_END,this.handleMediaPlayerEnd.bind(this)),this.sequenceModel=null,this.currentSequenceIndex=0,this.currentModel=null,this.pubSub=new ximpel.PubSub,this.state=this.STATE_STOPPED,t&&this.use(t,!0)},ximpel.SequencePlayer.prototype.EVENT_SEQUENCE_END="EVENT_SEQUENCE_END",ximpel.SequencePlayer.prototype.STATE_PLAYING="state_sp_playing",ximpel.SequencePlayer.prototype.STATE_PAUSED="state_sp_paused",ximpel.SequencePlayer.prototype.STATE_STOPPED="state_sp_stopped",ximpel.SequencePlayer.prototype.use=function(e,t){t||this.reset(),this.sequenceModel=e},ximpel.SequencePlayer.prototype.reset=function(e){this.mediaPlayer.stop(),this.state=this.STATE_STOPPED,this.currentModel=null,this.currentSequenceIndex=0,e&&this.clearEventHandlers()},ximpel.SequencePlayer.prototype.play=function(e){e&&this.use(e);{if(this.sequenceModel)return this.isPlaying()?(ximpel.warn("SequencePlayer.play(): play() called while already playing."),this):this.isPaused()?(this.resume(),this):(this.state=this.STATE_PLAYING,this.playbackController(),this);ximpel.error("SequencePlayer.play(): cannot start playing because no sequence model has been specified.")}},ximpel.SequencePlayer.prototype.playbackController=function(){var e=this.getNextItemToPlay();e?e instanceof ximpel.MediaModel?(this.playMediaModel(e),this.currentSequenceIndex++):ParallelMediaModel:this.pubSub.publish(this.EVENT_SEQUENCE_END)},ximpel.SequencePlayer.prototype.resume=function(){return this.isPaused()?(this.currentModel instanceof ximpel.MediaModel?this.mediaPlayer.resume():(itemToPlay,ParallelMediaModel),this.state=this.STATE_PLAYING,this):(ximpel.warn("SequencePlayer.resume(): resume() called while not in a paused state."),this)},ximpel.SequencePlayer.prototype.playMediaModel=function(e){this.currentModel=e,this.player.applyVariableModifiers(e.variableModifiers),this.mediaPlayer.play(e)},ximpel.SequencePlayer.prototype.pause=function(){return this.isPlaying()?(this.state=this.STATE_PAUSED,this.mediaPlayer.pause(),this):(ximpel.warn("SequencePlayer.pause(): pause() called while not in a playing state."),this)},ximpel.SequencePlayer.prototype.stop=function(){return this.isStopped()?(ximpel.warn("SequencePlayer.stop(): stop() called while already in a stopped state."),this):(this.state=this.STATE_STOPPED,this.reset(),this)},ximpel.SequencePlayer.prototype.isPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.SequencePlayer.prototype.isPaused=function(){return this.state===this.STATE_PAUSED},ximpel.SequencePlayer.prototype.isStopped=function(){return this.state===this.STATE_STOPPED},ximpel.SequencePlayer.prototype.handleMediaPlayerEnd=function(){this.playbackController()},ximpel.SequencePlayer.prototype.getNextItemToPlay=function(){return this.currentSequenceIndex<this.sequenceModel.list.length?this.sequenceModel.list[this.currentSequenceIndex]:null},ximpel.SequencePlayer.prototype.addEventHandler=function(e,t){return this.pubSub.subscribe(e,t),this},ximpel.SequencePlayer.prototype.clearEventHandlers=function(e){return this.pubSub.reset(),this},ximpel.MediaType=function(){},ximpel.MediaType.prototype.EVENT_MEDIA_END="ended",ximpel.MediaType.prototype.play=function(){return this.mediaPlay?this.mediaPlay():ximpel.error("ximpel.MediaType(): Invalid custom media type! A custom media type does not conform to the required interface. The media type has not implemented the mediaPlay() method."),this},ximpel.MediaType.prototype.pause=function(){return this.mediaPause?this.mediaPause():ximpel.error("ximpel.MediaType(): Invalid custom media type! A custom media type does not conform to the required interface. The media type has not implemented the mediaPause() method."),this},ximpel.MediaType.prototype.stop=function(){return this.mediaStop?this.mediaStop():ximpel.error("ximpel.MediaType(): Invalid custom media type! A custom media type does not conform to the required interface. The media type has not implemented the mediaStop() method."),this},ximpel.MediaType.prototype.isPlaying=function(){if(this.mediaIsPlaying)return this.mediaIsPlaying();ximpel.error("ximpel.MediaType(): Invalid custom media type! A custom media type does not conform to the required interface. The media type has not implemented the mediaIsPlaying() method.")},ximpel.MediaType.prototype.isPaused=function(){if(this.mediaIsPaused)return this.mediaIsPaused();ximpel.error("ximpel.MediaType(): Invalid custom media type! A custom media type does not conform to the required interface. The media type has not implemented the mediaIsPaused() method.")},ximpel.MediaType.prototype.isStopped=function(){if(this.mediaIsStopped)return this.mediaIsStopped();ximpel.error("ximpel.MediaType(): Invalid custom media type! A custom media type does not conform to the required interface. The media type has not implemented the mediaIsStopped() method.")},ximpel.MediaType.prototype.ended=function(){return this.mediaEnded&&this.mediaEnded(),this.lazyLoadPubSub().publish(this.EVENT_MEDIA_END),this},ximpel.MediaType.prototype.destroy=function(){return this.mediaDestroy?this.mediaDestroy():(this.__mediaTypePubSub__=null,this)},ximpel.MediaType.prototype.onEnd=function(e){return this.addEventHandler(this.EVENT_MEDIA_END,e)},ximpel.MediaType.prototype.addEventHandler=function(e,t){switch(e){case this.EVENT_MEDIA_END:return this.lazyLoadPubSub().subscribe(this.EVENT_MEDIA_END,t);default:return ximpel.warn("MediaType.addEventHandler(): event type '"+e+"' is not supported."),null}},ximpel.MediaType.prototype.removeEventHandler=function(e,t){switch(e){case this.EVENT_MEDIA_END:return this.lazyLoadPubSub().unsubscribe(this.EVENT_MEDIA_END,t),!0;default:return ximpel.warn("MediaType.removeEventHandler(): event type '"+e+"' is not supported."),!1}},ximpel.MediaType.prototype.lazyLoadPubSub=function(){return this.__mediaTypePubSub__||(this.__mediaTypePubSub__=new ximpel.PubSub),this.__mediaTypePubSub__},ximpel.MediaTypeRegistration=function(e,t,i){var i=i||{};this.mediaTypeId=e,this.mediaTypeConstructor=t,this.allowedAttributes=i.allowedAttributes||[],this.requiredAttributes=i.reguiredAttributes||[],this.allowedChildren=i.allowedChildren||[],this.requiredChildren=i.requiredChildren||[]},ximpel.PubSub=function(){this.topics={}},ximpel.PubSub.prototype.reset=function(){this.topics={}},ximpel.PubSub.prototype.subscribe=function(e,t){return this.topics[e]||(this.topics[e]=[]),this.topics[e].push(t),t},ximpel.PubSub.prototype.unsubscribe=function(e,t){if(!this.topics[e])return this;for(var i=this.topics[e],s=0;s<i.length;s++)i[s]==t&&(i.splice(s,1),i.length<=0&&delete this.topics[e]);return this},ximpel.PubSub.prototype.publish=function(e,t){if(!this.topics[e]||this.topics[e].length<=0)return this;for(var i=this.topics[e],s=0;s<i.length;s++)(0,i[s])(t);return this},ximpel.PubSub.prototype.deleteTopic=function(e){return delete this.topics[e],this},ximpel.PubSub.prototype.hasSubscribers=function(e){if(this.topics[e]&&this.topics[e].length>0)return!0},ximpel.XimpelAppView=function(e,t,i,s){this.$appElement=this.determineAppElement(t),this.init(e,this.$appElement),this.initialAppWidth=this.determineAppWidth(i),this.initialAppHeight=this.determineAppHeight(s),this.$playerElement=$("<div></div>"),this.$controlsElement=$("<div></div>"),this.$wrapperElement=$("<div></div>"),this.$playButtonElement=$("<div></div>"),this.$pauseButtonElement=$("<div></div>"),this.$stopButtonElement=$("<div></div>"),this.$fullscreenButtonElement=$("<div></div>"),this.pubSub=new ximpel.PubSub,this.initElements()},ximpel.XimpelAppView.prototype=new ximpel.View,ximpel.XimpelAppView.prototype.DEFAULT_XIMPEL_APP_ELEMENT_ID="XIMPEL",ximpel.XimpelAppView.prototype.Z_INDEX_BASE_MAIN_ELEMENTS=16e6,ximpel.XimpelAppView.prototype.Z_INDEX_CONTROLS=ximpel.XimpelAppView.prototype.Z_INDEX_BASE_MAIN_ELEMENTS+2e3,ximpel.XimpelAppView.prototype.Z_INDEX_PLAYER=ximpel.XimpelAppView.prototype.Z_INDEX_BASE_MAIN_ELEMENTS+1e3,ximpel.XimpelAppView.prototype.NATIVE_PLAYER_ELEMENT_WIDTH="1920px",ximpel.XimpelAppView.prototype.NATIVE_PLAYER_ELEMENT_HEIGHT="1080px",ximpel.XimpelAppView.prototype.DEFAULT_APP_WIDTH="1024px",ximpel.XimpelAppView.prototype.DEFAULT_APP_HEIGHT="576px",ximpel.XimpelAppView.prototype.DEFAULT_CONTROL_HEIGHT="125px",ximpel.XimpelAppView.prototype.DEFAULT_CONTROL_WIDTH="125px",ximpel.XimpelAppView.prototype.APP_ELEMENT_CLASS="ximpelApp",ximpel.XimpelAppView.prototype.WRAPPER_ELEMENT_CLASS="ximpelWrapper",ximpel.XimpelAppView.prototype.PLAYER_ELEMENT_CLASS="ximpelPlayer",ximpel.XimpelAppView.prototype.CONTROLS_CLASS="ximpelControls",ximpel.XimpelAppView.prototype.CONTROL_CLASS="ximpelControl",ximpel.XimpelAppView.prototype.CONTROLS_DISPLAY_METHOD_OVERLAY_CLASS="ximpelControlsOverlay",ximpel.XimpelAppView.prototype.CONTROLS_DISPLAY_METHOD_FIXED_CLASS="ximpelControlsFixed",ximpel.XimpelAppView.prototype.CONTROLS_DISPLAY_METHOD_OVERLAY="overlay",ximpel.XimpelAppView.prototype.CONTROLS_DISPLAY_METHOD_FIXED="fixed",ximpel.XimpelAppView.prototype.PLAY_EVENT="play_button_clicked",ximpel.XimpelAppView.prototype.PAUSE_EVENT="pause_button_clicked",ximpel.XimpelAppView.prototype.STOP_EVENT="stop_button_clicked",ximpel.XimpelAppView.prototype.initElements=function(){this.initAppElement(),this.initPlayerElement(),this.initControlsElement(),this.initWrapperElement(),this.initButtonElements()},ximpel.XimpelAppView.prototype.initAppElement=function(){this.$appElement.css({position:"relative",width:this.initialAppWidth,height:this.initialAppHeight}),this.$appElement.addClass(this.APP_ELEMENT_CLASS)},ximpel.XimpelAppView.prototype.initPlayerElement=function(){this.$playerElement.css({position:"absolute",top:"0px",left:"0px",width:this.NATIVE_PLAYER_ELEMENT_WIDTH,height:this.NATIVE_PLAYER_ELEMENT_HEIGHT,"z-index":this.Z_INDEX_PLAYER}),this.$playerElement.addClass(this.PLAYER_ELEMENT_CLASS),this.$playerElement.appendTo(this.$wrapperElement)},ximpel.XimpelAppView.prototype.initControlsElement=function(){this.$controlsElement.hide(),this.$controlsElement.css({position:"absolute",top:this.$playerElement.height()+"px",left:"0px",width:"100%",height:this.DEFAULT_CONTROL_HEIGHT,"z-index":this.Z_INDEX_CONTROLS}),this.updateControlsElementClass(),this.$controlsElement.appendTo(this.$wrapperElement)},ximpel.XimpelAppView.prototype.initWrapperElement=function(){this.$wrapperElement.css({position:"absolute",top:"0px",left:"0px",width:this.$playerElement.width()+"px",height:this.$playerElement.height()+"px"}),this.$wrapperElement.addClass(this.WRAPPER_ELEMENT_CLASS),this.$wrapperElement.appendTo(this.$appElement)},ximpel.XimpelAppView.prototype.initButtonElements=function(){var e=this.DEFAULT_CONTROL_HEIGHT,t=this.DEFAULT_CONTROL_WIDTH;this.initButtonElement(this.$playButtonElement,"ximpel/images/play_button.png","left",e,t,this.playHandler.bind(this)),this.initButtonElement(this.$pauseButtonElement,"ximpel/images/pause_button.png","left",e,t,this.pauseHandler.bind(this)),this.initButtonElement(this.$stopButtonElement,"ximpel/images/stop_button.png","left",e,t,this.stopHandler.bind(this)),this.initButtonElement(this.$fullscreenButtonElement,"ximpel/images/fullscreen_button.png","right",e,t,this.fullscreenHandler.bind(this))},ximpel.XimpelAppView.prototype.initButtonElement=function(e,t,i,s,o,r){e.css({float:i,"background-image":"url("+t+")","background-size":"cover",height:o,width:s}),e.hover(function(){$(this).css("cursor","pointer")},function(){$(this).css("cursor","default")}),e.addClass(this.CONTROL_CLASS),e.on("click",r),e.hide(),e.appendTo(this.$controlsElement)},ximpel.XimpelAppView.prototype.renderView=function(e){this.model;(!(e=e||this.$appElement.parent())||e.length<=0)&&(e=$(document.body)),this.$appElement.parent().length<=0&&this.$appElement.appendTo(e),this.renderControls(),this.renderWrapper(),this.listenForWindowResize(),this.listenForKeyPresses(),this.listenForFullscreenChange()},ximpel.XimpelAppView.prototype.renderControls=function(){if(this.controlsEnabled()){this.updateControlsElementClass();var e=this.determineControlsPosition();this.$controlsElement.css({left:e.x+"px",top:e.y+"px"}),this.$controlsElement.show(),this.renderControlButtons()}},ximpel.XimpelAppView.prototype.renderControlButtons=function(){var e=this.$controlsElement.height(),t=e;this.model.appReadyState===this.model.APP_READY_STATE_READY&&this.renderPlaybackButtons(t,e),this.$fullscreenButtonElement.show()},ximpel.XimpelAppView.prototype.renderPlaybackButtons=function(e,t){this.model.playerState===this.model.PLAYER_STATE_PLAYING?(this.$playButtonElement.hide(),this.$pauseButtonElement.show(),this.$stopButtonElement.show()):this.model.playerState===this.model.PLAYER_STATE_PAUSED?(this.$pauseButtonElement.hide(),this.$playButtonElement.show(),this.$stopButtonElement.show()):this.model.PLAYER_STATE_STOPPED&&(this.$pauseButtonElement.hide(),this.$stopButtonElement.hide(),this.$playButtonElement.show())},ximpel.XimpelAppView.prototype.fullscreenHandler=function(){this.toggleFullscreen()},ximpel.XimpelAppView.prototype.playHandler=function(){this.pubSub.publish(this.PLAY_EVENT)},ximpel.XimpelAppView.prototype.pauseHandler=function(){this.pubSub.publish(this.PAUSE_EVENT)},ximpel.XimpelAppView.prototype.stopHandler=function(){this.pubSub.publish(this.STOP_EVENT)},ximpel.XimpelAppView.prototype.registerPlayHandler=function(e){return this.pubSub.subscribe(this.PLAY_EVENT,e)},ximpel.XimpelAppView.prototype.registerPauseHandler=function(e){return this.pubSub.subscribe(this.PAUSE_EVENT,e)},ximpel.XimpelAppView.prototype.registerStopHandler=function(e){return this.pubSub.subscribe(this.STOP_EVENT,e)},ximpel.XimpelAppView.prototype.updateControlsElementClass=function(){switch(this.$controlsElement.removeClass(),this.getControlsDisplayMethod()){case this.CONTROLS_DISPLAY_METHOD_OVERLAY:e=this.CONTROLS_DISPLAY_METHOD_OVERLAY_CLASS;break;case this.CONTROLS_DISPLAY_METHOD_FIXED:var e=this.CONTROLS_DISPLAY_METHOD_FIXED_CLASS}this.$controlsElement.addClass(this.CONTROLS_CLASS+" "+e)},ximpel.XimpelAppView.prototype.renderWrapper=function(){var e=this.determineWrapperDimensions();this.$wrapperElement.css({width:e.width+"px",height:e.height+"px"}),this.$wrapperElement.show();var t=this.$appElement.width(),i=this.$appElement.height(),s=this.$wrapperElement.width(),o=this.$wrapperElement.height();this.scaleToFit(this.$wrapperElement,t,i,s,o);var r=this.$wrapperElement[0].getBoundingClientRect().width,n=this.$wrapperElement[0].getBoundingClientRect().height;this.repositionInCenter(this.$wrapperElement,t,i,r,n)},ximpel.XimpelAppView.prototype.determineControlsPosition=function(){var e=this.determineWrapperDimensions(),t=this.getControlsDisplayMethod();if(t===this.CONTROLS_DISPLAY_METHOD_OVERLAY)var i=0,s=e.height-this.$controlsElement.height();else if(t===this.CONTROLS_DISPLAY_METHOD_FIXED)var i=0,s=e.height-this.$controlsElement.height();else var i=0,s=0;return{x:i,y:s}},ximpel.XimpelAppView.prototype.determineWrapperDimensions=function(){var e=this.getControlsDisplayMethod();if(this.controlsEnabled()){if(e===this.CONTROLS_DISPLAY_METHOD_OVERLAY)var t=this.$playerElement.width(),i=this.$playerElement.height();else if(e===this.CONTROLS_DISPLAY_METHOD_FIXED)var t=this.$playerElement.width(),i=this.$playerElement.height()+this.$controlsElement.height()}else var t=this.$playerElement.width(),i=this.$playerElement.height();return{width:t,height:i}},ximpel.XimpelAppView.prototype.destroyView=function(){},ximpel.XimpelAppView.prototype.listenForWindowResize=function(){var e,t="ximpelAppViewWindowResize_"+this.model.appId;$(window).off("resize."+t),$(window).on("resize."+t,function(){clearTimeout(e),e=setTimeout(this.windowResizeHandler.bind(this),100)}.bind(this))},ximpel.XimpelAppView.prototype.windowResizeHandler=function(){this.render()},ximpel.XimpelAppView.prototype.listenForKeyPresses=function(){var e="ximpelAppView_"+this.model.appId;this.$appElement.off("keypress."+e),this.$appElement.on("keypress."+e,function(e){102===e.which?this.toggleFullscreen():115===e.which?this.playHandler():113===e.which?this.stopHandler():112===e.which&&this.pauseHandler()}.bind(this))},ximpel.XimpelAppView.prototype.toggleFullscreen=function(){var e=this.$appElement[0];this.fullscreenElement()?this.exitFullscreen():this.fullscreenSupported()&&this.requestFullscreen(e)},ximpel.XimpelAppView.prototype.exitFullscreen=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else{if(!document.msExitFullscreen)return!1;document.msExitFullscreen()}return!0},ximpel.XimpelAppView.prototype.fullscreenElement=function(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement},ximpel.XimpelAppView.prototype.requestFullscreen=function(e){if(e.requestFullscreen)e.requestFullscreen();else if(e.webkitRequestFullscreen)e.webkitRequestFullscreen();else if(e.mozRequestFullScreen)e.mozRequestFullScreen();else{if(!e.msRequestFullscreen)return!1;e.msRequestFullscreen()}return!0},ximpel.XimpelAppView.prototype.fullscreenSupported=function(){return document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled},ximpel.XimpelAppView.prototype.listenForFullscreenChange=function(){var e="ximpelAppViewFullscreen_"+this.model.appId;$(document).off("webkitfullscreenchange."+e+" mozfullscreenchange."+e+" fullscreenchange."+e+" MSFullscreenChange."+e),$(document).on("webkitfullscreenchange."+e+" mozfullscreenchange."+e+" fullscreenchange."+e+" MSFullscreenChange."+e,this.fullscreenChangeHandler.bind(this))},ximpel.XimpelAppView.prototype.fullscreenChangeHandler=function(){this.fullscreenElement()?(this.$appElement.width($(window).width()),this.$appElement.height($(window).height())):(this.$appElement.width(this.initialAppWidth),this.$appElement.height(this.initialAppHeight)),this.render()},ximpel.XimpelAppView.prototype.getScaleFactor=function(e,t,i,s){return Math.min(e/i,t/s)},ximpel.XimpelAppView.prototype.getCenteredRectangleCoordinates=function(e,t,i,s){return{x:Math.abs(Math.round((e-i)/2)),y:Math.abs(Math.round((t-s)/2))}},ximpel.XimpelAppView.prototype.getPlayerElement=function(){return this.$playerElement},ximpel.XimpelAppView.prototype.scaleToFit=function(e,t,i,s,o){var r=this.getScaleFactor(t,i,s,o);e.css({"-webkit-transform":"scale("+r+","+r+")","-moz-transform":"scale("+r+","+r+")","-ms-transform":"scale("+r+","+r+")","-o-transform":"scale("+r+","+r+")",transform:"scale("+r+","+r+")","-webkit-transform-origin":"top left","-moz-transform-origin":"top left","-ms-transform-origin":"top left","-o-transform-origin":"top left","transform-origin":"top left"})},ximpel.XimpelAppView.prototype.repositionInCenter=function(e,t,i,s,o){var r=this.getCenteredRectangleCoordinates(t,i,s,o);e.css({left:r.x+"px",top:r.y+"px"})},ximpel.XimpelAppView.prototype.getControlsDisplayMethod=function(){return this.model.configModel.controlsDisplayMethod},ximpel.XimpelAppView.prototype.controlsEnabled=function(){return this.model.configModel.enableControls},ximpel.XimpelAppView.prototype.determineAppWidth=function(e){this.$appElement.parent();return e||(this.$appElement.width()>0?this.$appElement.width()+"px":this.DEFAULT_APP_WIDTH)},ximpel.XimpelAppView.prototype.determineAppHeight=function(e){this.$appElement.parent();return e||(this.$appElement.height()>0?this.$appElement.height()+"px":this.DEFAULT_APP_HEIGHT)},ximpel.XimpelAppView.prototype.determineAppElement=function(e){var t=ximpel.getElement(e);return t||(t=this.createAppElement(e)),t},ximpel.XimpelAppView.prototype.createAppElement=function(e){for(var t=e=e||this.DEFAULT_XIMPEL_APP_ELEMENT_ID,i=2;document.getElementById(t);)t=e+"-"+i,i++;return $("<div></div>").attr({id:t})},ximpel.OverlayView=function(e,t){this.init(e,t)},ximpel.OverlayView.prototype=new ximpel.View,ximpel.OverlayView.prototype.SHAPE_RECTANGLE="rectangle",ximpel.OverlayView.prototype.SHAPE_SQUARE="square",ximpel.OverlayView.prototype.SHAPE_OVAL="oval",ximpel.OverlayView.prototype.SHAPE_CIRCLE="circle",ximpel.OverlayView.prototype.CSS_OVERYLAY_CLASS="overlay",ximpel.OverlayView.prototype.CSS_OVERLAY_OVAL_CLASS="overlayOval",ximpel.OverlayView.prototype.CSS_NO_SELECT_CLASS="noSelect",ximpel.OverlayView.prototype.renderView=function(){var e=this.model,t=$("<div></div>").addClass(this.CSS_NO_SELECT_CLASS).addClass(this.CSS_OVERYLAY_CLASS).css({top:e.y,left:e.x}),i=$("<span></span>");e.text&&i.text(e.text);var s=$("<div></div>");switch(t.append(s),t.append(i),e.shape){case this.SHAPE_RECTANGLE:this.makeRectangle(t,e.width,e.height);break;case this.SHAPE_SQUARE:this.makeSquare(t,e.side);break;case this.SHAPE_OVAL:this.makeOval(t,e.width,e.height);break;case this.SHAPE_CIRCLE:this.makeCircle(t,e.diameter)}this.setInitialOverlayStyle(t,e),t.mouseover(function(){this.setHoverOverlayStyle(t,e)}.bind(this)),t.mouseout(function(){this.setNonHoverOverlayStyle(t,e)}.bind(this)),this.$el.remove(),this.$el=t},ximpel.OverlayView.prototype.setInitialOverlayStyle=function(e,t){e.children("span").css({"text-align":t.textAlign}),t.backgroundImage&&e.children("div").css({"background-image":"url("+t.backgroundImage+")","background-size":"cover","background-repeat":"no-repeat","background-position":"center center"}),this.setNonHoverOverlayStyle(e,t)},ximpel.OverlayView.prototype.setNonHoverOverlayStyle=function(e,t){e.children("span").css({color:t.textColor,"font-size":t.fontSize,"font-family":t.fontFamily}),e.children("div").css({opacity:t.opacity,"background-color":t.backgroundColor})},ximpel.OverlayView.prototype.setHoverOverlayStyle=function(e,t){e.children("span").css({color:t.hoverTextColor||t.textColor,"font-size":t.hoverFontSize||t.fontSize,"font-family":t.hoverFontFamily||t.fontFamily}),e.children("div").css({opacity:t.hoverOpacity,"background-color":t.hoverBackgroundColor||t.backgroundColor})},ximpel.OverlayView.prototype.destroyView=function(){},ximpel.OverlayView.prototype.makeRectangle=function(e,t,i){return t=this.ensureUnit(t,"px"),i=this.ensureUnit(i,"px"),e.css({width:t,height:i,"line-height":i}),this},ximpel.OverlayView.prototype.makeSquare=function(e,t){this.makeRectangle(e,t,t)},ximpel.OverlayView.prototype.makeOval=function(e,t,i){return t=this.ensureUnit(t,"px"),i=this.ensureUnit(i,"px"),e.addClass(this.CSS_OVERLAY_OVAL_CLASS),e.css({width:t,height:i,"line-height":i,"border-radius":"50%"}),this},ximpel.OverlayView.prototype.makeCircle=function(e,t){return this.makeOval(e,t,t),this},ximpel.OverlayView.prototype.ensureUnit=function(e,t){var t=t||"px";return this.isNumeric(e.toString().slice(-1))?e+t:e},ximpel.OverlayView.prototype.isNumeric=function(e){return(e>0||0===e||"0"===e||e<0)&&!0!==e&&isFinite(e)},ximpel.QuestionView=function(e,t){this.init(e,t),this.questionFontSize="40px",this.nextQuestionIndex=0,this.$optionsContainer=null,this.isAnswered=!1,this.timeoutHandlerQuestionAnsweredPause=null},ximpel.QuestionView.prototype=new ximpel.View,ximpel.QuestionView.prototype.EVENT_QUESTION_ANSWERED="answered",ximpel.QuestionView.prototype.EVENT_QUESTION_ENDED="ended",ximpel.QuestionView.prototype.CSS_QUESTION_CLASS="question",ximpel.QuestionView.prototype.CSS_QUESTION_TEXT_CLASS="questionText",ximpel.QuestionView.prototype.CSS_QUESTION_OPTION_CLASS="questionOption",ximpel.QuestionView.prototype.CSS_NO_SELECT_CLASS="noSelect",ximpel.QuestionView.prototype.renderView=function(){for(var e=this.model,t=this.$question=$("<div></div>").addClass(this.CSS_QUESTION_CLASS).addClass(this.CSS_NO_SELECT_CLASS).css({"text-align":"center",width:"100%","min-height":"100px",top:"15%",left:"0px","font-size":this.questionFontSize,padding:"0px 0px 0px 0px"}),i=$("<div></div>").addClass(this.CSS_QUESTION_TEXT_CLASS).css({"background-color":"rgba( 0, 0, 0, 0.8 )",color:"white",float:"left",width:"70%",padding:"10px 0px 10px 0px",margin:"0px 15% 0px 15%"}).html(e.questionText),s=$("<div></div>").css({float:"left",width:"70%",padding:"0px 15% 0px 15%"}),o=0;o<e.options.length;o++){var r=e.options[o],n=$("<span></span>").css({"background-color":"rgba( 255, 255, 255, 0.7 )",color:"black",display:"block",cursor:"pointer",width:"100%",padding:"10px 0px 10px 0px"}).mouseover(function(){$(this).css("background-color","rgba( 255, 255, 255, 0.9 )")}).mouseout(function(){$(this).css("background-color","rgba( 255, 255, 255, 0.7 )")}).addClass(this.CSS_QUESTION_OPTION_CLASS);n.one("click",function(e,t,i){this.questionAnswerHandler(e,t,i)}.bind(this,s,n,r.optionName));var l=r.optionText,a=$(document.createTextNode(l));n.append(a),s.append(n)}t.append(i),t.append(s),this.$optionsContainer=s,this.$el.remove(),this.$el=t},ximpel.QuestionView.prototype.questionAnswerHandler=function(e,t,i){this.isAnswered=!0,e.find("."+this.CSS_QUESTION_OPTION_CLASS).off("mouseover mouseout click"),this.model.answer===i?t.css("background-color","rgba(0, 255, 0, 0.7)"):t.css("background-color","rgba(255, 0, 0, 0.7)"),this.timeoutHandlerQuestionAnsweredPause=setTimeout(function(){this.$el.fadeOut(400,function(){this.pubSub.publish(this.EVENT_QUESTION_ENDED,i)}.bind(this))}.bind(this),1e3),this.pubSub.publish(this.EVENT_QUESTION_ANSWERED,i)},ximpel.QuestionView.prototype.hideQuestion=function(){this.$optionsContainer.find("."+this.CSS_QUESTION_OPTION_CLASS).off("mouseover mouseout click"),this.$el.fadeOut(400,function(){this.pubSub.publish(this.EVENT_QUESTION_ENDED)}.bind(this))},ximpel.QuestionView.prototype.addEventHandler=function(e,t){switch(e){case this.EVENT_QUESTION_ENDED:return this.pubSub.subscribe(this.EVENT_QUESTION_ENDED,t);case this.EVENT_QUESTION_ANSWERED:return this.pubSub.subscribe(this.EVENT_QUESTION_ANSWERED,t);default:return ximpel.warn("QuestionView.addEventHandler(): event type '"+e+"' is not supported."),null}},ximpel.QuestionView.prototype.removeEventHandler=function(e,t){switch(e){case"end":return this.pubSub.unsubscribe(this.EVENT_QUESTION_ENDED,t),!0;default:return ximpel.warn("QuestionView.removeEventHandler(): event type '"+e+"' is not supported. Can't add/remove event handlers of this type."),!1}},ximpel.QuestionView.prototype.destroyView=function(){this.$el.stop(!0),clearTimeout(this.timeoutHandlerQuestionAnsweredPause)},ximpel.mediaTypeDefinitions.Video=function(e,t,i,s){this.customElements=e,this.customAttributes=t,this.$attachTo=i,this.player=s,this.mute="true"===this.customAttributes.mute||!1,this.x=this.customAttributes.x||"center",this.y=this.customAttributes.y||"center",this.width=this.customAttributes.width,this.height=this.customAttributes.height,this.startTime=t.startTime||0,this.$videoContainer=null,this.$video=null,this.$progressBar=null;var o=ximpel.filterArrayOfObjects(e,"elementName","source")[0];this.showProgressBar="true"==t.progressbar,this.$htmlSourceElements=this.getHtmlSourceElements(o),this.bufferingPromise=null,this.state=this.STATE_STOPPED},ximpel.mediaTypeDefinitions.Video.prototype=new ximpel.MediaType,ximpel.mediaTypeDefinitions.Video.prototype.STATE_PLAYING="state_video_playing",ximpel.mediaTypeDefinitions.Video.prototype.STATE_PAUSED="state_video_paused",ximpel.mediaTypeDefinitions.Video.prototype.STATE_STOPPED="state_video_stopped",ximpel.mediaTypeDefinitions.Video.prototype.timeupdate=function(e){var t=e.currentTarget.currentTime/e.currentTarget.duration*100;this.$progressBar&&this.$progressBar.css({width:t+"%"})},ximpel.mediaTypeDefinitions.Video.prototype.mediaPlay=function(){if(this.state!==this.STATE_PLAYING){if(this.state!==this.STATE_PAUSED){this.state=this.STATE_PLAYING;var e=this.$video=$("<video />",{preload:"none"}),t=e[0];this.$videoContainer=$('<div class="ximpelVideoContainer" />').append(e);e.append(this.$htmlSourceElements),e.on("ended",this.ended.bind(this)),e.on("timeupdate",this.timeupdate.bind(this)),e.on("timeupdate",this.timeupdate.bind(this)),e.one("loadedmetadata",function(){if(t.currentTime=this.startTime,this.showProgressBar){var e=this.$progressBar=$("<div />");$('<div class="ximpelProgressBar" />').append(e).appendTo(this.$videoContainer)}this.$videoContainer.appendTo(this.$attachTo),this.calculateVideoDetails()}.bind(this));var i=new $.Deferred;return i.done(function(){this.state===this.STATE_PLAYING&&(e.prop("muted",this.mute),t.play())}.bind(this)),e.one("canplaythrough",function(){i.resolve()}.bind(this)),e.error(function(e){ximpel.warn("Video.mediaPlay(): failed to buffer the video: '"+t.src+"'."),i.reject()}.bind(this)),t.load(),this.bufferingPromise=i.promise(),this.bufferingPromise}this.resumePlayback()}},ximpel.mediaTypeDefinitions.Video.prototype.resumePlayback=function(){this.state=this.STATE_PLAYING,"resolved"===this.bufferingPromise.state()&&this.$video[0].play()},ximpel.mediaTypeDefinitions.Video.prototype.mediaPause=function(){this.state===this.STATE_PLAYING&&(this.state=this.STATE_PAUSED,this.$video[0].pause())},ximpel.mediaTypeDefinitions.Video.prototype.mediaStop=function(){if(this.state!==this.STATE_STOPPED){this.state=this.STATE_STOPPED;var e=this.$video[0];e.pause(),e.src="",e.load(),this.$videoContainer.detach(),this.$videoContainer.remove(),this.$videoContainer=null,this.$video=null,this.$progressBar=null,this.bufferingPromise=null}},ximpel.mediaTypeDefinitions.Video.prototype.mediaIsPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.mediaTypeDefinitions.Video.prototype.mediaIsPaused=function(){return this.state===this.STATE_PAUSED},ximpel.mediaTypeDefinitions.Video.prototype.mediaIsStopped=function(){return this.state===this.STATE_STOPPED},ximpel.mediaTypeDefinitions.Video.prototype.calculateVideoDetails=function(){var e=this.$attachTo.width(),t=this.$attachTo.height(),i="center"===this.x?"0px":this.x,s="center"===this.y?"0px":this.y;if(this.width||this.height)if(this.width)if(this.height)var o=this.width,r=this.height;else var o=this.width,r="auto";else var o="auto",r=this.height;else if(this.$video[0].videoWidth/this.$video[0].videoHeight>=e/t)var o="100%",r="auto";else var o="auto",r="100%";if(this.$videoContainer.css({position:"absolute",width:o,height:r,left:i,top:s}),"center"===this.x)i=Math.round(Math.abs(this.$attachTo.width()-this.$video.width())/2);if("center"===this.y)s=Math.round(Math.abs(this.$attachTo.height()-this.$video.height())/2);this.$videoContainer.css({left:i,top:s})},ximpel.mediaTypeDefinitions.Video.prototype.getPlayTime=function(){var e=this.$video[0];return e.currentTime&&0!=e.currentTime?1e3*(e.currentTime-this.startTime):0},ximpel.mediaTypeDefinitions.Video.prototype.getHtmlSourceElements=function(e){var t=e.elementAttributes.file,i=e.elementAttributes.extensions||"";i=i.replace(/\s/g,""),extensionsArray=i.split(",");var s=e.elementAttributes.types||"";s=s.replace(/\s/g,""),typesArray=""!==s?s.split(","):[];for(var o=$([]),r=0;r<extensionsArray.length;r++){var n=typesArray[r]||"",l=t+"."+extensionsArray[r],a=this.player.getConfigProperty("mediaDirectory")||"";""!=a&&(l=a+"/"+l);var p=$("<source />").attr({src:l,type:n});o=o.add(p)}return o};var mediaTypeRegistrationObject=new ximpel.MediaTypeRegistration("video",ximpel.mediaTypeDefinitions.Video,{allowedAttributes:["mute","width","height","x","y","startTime"],requiredAttributes:[],allowedChildren:["source"],requiredChildren:["source"]});ximpel.registerMediaType(mediaTypeRegistrationObject),ximpel.mediaTypeDefinitions.Iframe=function(e,t,i,s){this.customElements=e,this.customAttributes=t,this.$parentElement=i,this.player=s;var o=this.customAttributes.url,r=this.customAttributes.backgroundColor;null==r&&(r="#000000");var n=this.customAttributes.containerBackgroundColor;null==n&&(n="#000000");var l=this.customAttributes.x;null==l&&(l=0);var a=this.customAttributes.y;null==a&&(a=0);var p=this.customAttributes.width;null==p&&(p=1920);var u=this.customAttributes.height;null==u&&(u=1080),this.$iframeSpan=$('<div style="background-color:'+n+'" class="container"></div>'),this.$iframeSpan.html($('<iframe width="'+p+'" height="'+u+'" style="margin-left:'+l+"; margin-top:"+a+"; border:0px solid white; top: 500px; background-color:"+r+'" wmode="Opaque" src="'+o+'"></iframe>')),this.state="stopped"},ximpel.mediaTypeDefinitions.Iframe.prototype=new ximpel.MediaType,ximpel.mediaTypeDefinitions.Iframe.prototype.mediaPlay=function(){this.state="playing",this.$parentElement.append(this.$iframeSpan)},ximpel.mediaTypeDefinitions.Iframe.prototype.mediaPause=function(){this.state="paused"},ximpel.mediaTypeDefinitions.Iframe.prototype.mediaStop=function(){this.state="stopped",this.$iframeSpan.detach()},ximpel.mediaTypeDefinitions.Iframe.prototype.mediaIsPlaying=function(){return"playing"===this.state},ximpel.mediaTypeDefinitions.Iframe.prototype.mediaIsPaused=function(){return"paused"===this.state},ximpel.mediaTypeDefinitions.Iframe.prototype.mediaIsStopped=function(){return"stopped"===this.state};var r=new ximpel.MediaTypeRegistration("iframe",ximpel.mediaTypeDefinitions.Iframe,{allowedAttributes:["url","width","height","backgroundColor","containerBackgroundColor","x","y"],requiredAttributes:["url"],allowedChildren:[],requiredChildren:[]});ximpel.registerMediaType(r),ximpel.mediaTypeDefinitions.Image=function(e,t,i,s){this.customElements=e,this.customAttributes=t,this.$attachTo=i,this.player=s,this.x=this.customAttributes.x||"center",this.y=this.customAttributes.y||"center",this.width=this.customAttributes.width,this.height=this.customAttributes.height;var o=s.getConfigProperty("mediaDirectory")||"";this.imageSource=t.src||"",""!=o&&(this.imageSource=o+"/"+this.imageSource),this.$image=null,this.loadPromise=null,this.state=this.STATE_STOPPED},ximpel.mediaTypeDefinitions.Image.prototype=new ximpel.MediaType,ximpel.mediaTypeDefinitions.Image.prototype.STATE_PLAYING="state_image_playing",ximpel.mediaTypeDefinitions.Image.prototype.STATE_PAUSED="state_image_paused",ximpel.mediaTypeDefinitions.Image.prototype.STATE_STOPPED="state_image_stopped",ximpel.mediaTypeDefinitions.Image.prototype.mediaPlay=function(){if(this.state!==this.STATE_PLAYING){if(this.state!==this.STATE_PAUSED){this.state=this.STATE_PLAYING,this.$image=$("<img />");var e=new $.Deferred;return this.$image.on("load",function(){e.resolve(),this.$image.appendTo(this.$attachTo),this.calculateImageDetails()}.bind(this)),this.$image.on("error",function(){ximpel.warn("Image.mediaPreload(): failed to preload image '"+$image[0].src+"'."),e.reject()}),this.$image.attr("src",this.imageSource),this.loadPromise=e.promise(),this.loadPromise}this.resumePlayback()}},ximpel.mediaTypeDefinitions.Image.prototype.resumePlayback=function(){this.state=this.STATE_PLAYING},ximpel.mediaTypeDefinitions.Image.prototype.mediaPause=function(){this.state===this.STATE_PLAYING&&(this.state=this.STATE_PAUSED)},ximpel.mediaTypeDefinitions.Image.prototype.mediaStop=function(){this.state!==this.STATE_STOPPED&&(this.state=this.STATE_STOPPED,this.$image.detach(),this.$image.remove(),this.$image=null,this.loadPromise=null)},ximpel.mediaTypeDefinitions.Image.prototype.mediaIsPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.mediaTypeDefinitions.Image.prototype.mediaIsPaused=function(){return this.state===this.STATE_PAUSED},ximpel.mediaTypeDefinitions.Image.prototype.mediaIsStopped=function(){return this.state===this.STATE_STOPPED},ximpel.mediaTypeDefinitions.Image.prototype.calculateImageDetails=function(){var e=this.$attachTo.width(),t=this.$attachTo.height(),i="center"===this.x?"0px":this.x,s="center"===this.y?"0px":this.y;if(this.width||this.height)if(this.width)if(this.height)var o=this.width,r=this.height;else var o=this.width,r="auto";else var o="auto",r=this.height;else if(this.$image[0].width/this.$image[0].height>=e/t)var o="100%",r="auto";else var o="auto",r="100%";if(this.$image.attr({width:o,height:r}).css({position:"absolute",left:i,top:s}),"center"===this.x)i=Math.round(Math.abs(this.$attachTo.width()-this.$image.width())/2);if("center"===this.y)s=Math.round(Math.abs(this.$attachTo.height()-this.$image.height())/2);this.$image.css({left:i,top:s})};var mediaTypeRegistrationObject=new ximpel.MediaTypeRegistration("image",ximpel.mediaTypeDefinitions.Image,{allowedAttributes:["src","width","height","x","y"],requiredAttributes:["src"],allowedChildren:[],requiredChildren:[]});ximpel.registerMediaType(mediaTypeRegistrationObject),ximpel.mediaTypeDefinitions.Audio=function(e,t,i,s){this.customElements=e,this.customAttributes=t,this.$attachTo=i,this.player=s,this.startTime=t.startTime||0,this.$audio=null;var o=ximpel.filterArrayOfObjects(e,"elementName","source")[0];this.$htmlSourceElements=this.getHtmlSourceElements(o),this.bufferingPromise=null,this.state=this.STATE_STOPPED},ximpel.mediaTypeDefinitions.Audio.prototype=new ximpel.MediaType,ximpel.mediaTypeDefinitions.Audio.prototype.STATE_PLAYING="state_audio_playing",ximpel.mediaTypeDefinitions.Audio.prototype.STATE_PAUSED="state_audio_paused",ximpel.mediaTypeDefinitions.Audio.prototype.STATE_STOPPED="state_audio_stopped",ximpel.mediaTypeDefinitions.Audio.prototype.mediaPlay=function(){if(this.state!==this.STATE_PLAYING){if(this.state!==this.STATE_PAUSED){this.state=this.STATE_PLAYING;var e=this.$audio=$("<audio />",{preload:"none"}),t=e[0];e.append(this.$htmlSourceElements),e.on("ended",this.ended.bind(this)),e.one("loadedmetadata",function(){t.currentTime=this.startTime,e.appendTo(this.$attachTo)}.bind(this));var i=new $.Deferred;return i.done(function(){this.state===this.STATE_PLAYING&&t.play()}.bind(this)),e.one("canplaythrough",function(){i.resolve()}.bind(this)),e.error(function(e){ximpel.warn("Audio.mediaPlay(): failed to buffer the audio: '"+t.src+"'."),i.reject()}.bind(this)),t.load(),this.bufferingPromise=i.promise(),this.bufferingPromise}this.resumePlayback()}},ximpel.mediaTypeDefinitions.Audio.prototype.resumePlayback=function(){this.state=this.STATE_PLAYING,"resolved"===this.bufferingPromise.state()&&this.$audio[0].play()},ximpel.mediaTypeDefinitions.Audio.prototype.mediaPause=function(){this.state===this.STATE_PLAYING&&(this.state=this.STATE_PAUSED,this.$audio[0].pause())},ximpel.mediaTypeDefinitions.Audio.prototype.mediaStop=function(){if(this.state!==this.STATE_STOPPED){this.state=this.STATE_STOPPED;var e=this.$audio,t=this.$audio[0];t.pause(),t.src="",t.load(),e.detach(),e.remove(),this.$audio=null,this.bufferingPromise=null}},ximpel.mediaTypeDefinitions.Audio.prototype.mediaIsPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.mediaTypeDefinitions.Audio.prototype.mediaIsPaused=function(){return this.state===this.STATE_PAUSED},ximpel.mediaTypeDefinitions.Audio.prototype.mediaIsStopped=function(){return this.state===this.STATE_STOPPED},ximpel.mediaTypeDefinitions.Audio.prototype.getPlayTime=function(){var e=this.$audio[0];return 0==e.currentTime?0:1e3*(e.currentTime-this.startTime)},ximpel.mediaTypeDefinitions.Audio.prototype.getHtmlSourceElements=function(e){var t=e.elementAttributes.file,i=e.elementAttributes.extensions||"";i=i.replace(/\s/g,""),extensionsArray=i.split(",");var s=e.elementAttributes.types||"";s=s.replace(/\s/g,""),typesArray=""!==s?s.split(","):[];for(var o=$([]),r=0;r<extensionsArray.length;r++){var n=typesArray[r]||"",l=t+"."+extensionsArray[r],a=this.player.getConfigProperty("mediaDirectory")||"";""!=a&&(l=a+"/"+l);var p=$("<source />").attr({src:l,type:n});o=o.add(p)}return o};var mediaTypeRegistrationObject=new ximpel.MediaTypeRegistration("audio",ximpel.mediaTypeDefinitions.Audio,{allowedAttributes:[],requiredAttributes:[],allowedChildren:["source"],requiredChildren:["source"]});ximpel.registerMediaType(mediaTypeRegistrationObject),ximpel.mediaTypeDefinitions.YouTube=function(e,t,i,s){this.customElements=e,this.customAttributes=t,this.$attachTo=i,this.player=s,this.videoId=t.id,this.mute=t.mute,this.x=t.x||"center",this.y=t.y||"center",this.width=t.width||this.$attachTo.width()+"px",this.height=t.height||this.$attachTo.height()+"px",this.startTime=t.startTime||0,this.$youtubeContainer=null,this.$youtubePlaceholder=null,this.$youtubeClickCatcher=null,this.youtubePlayer=null,this.readyToPlayPromise=null,this.state=this.STATE_STOPPED},ximpel.mediaTypeDefinitions.YouTube.prototype=new ximpel.MediaType,ximpel.mediaTypeDefinitions.YouTube.prototype.CLASS_YOUTUBE_CONTAINER="youtubeContainer",ximpel.mediaTypeDefinitions.YouTube.prototype.CLASS_YOUTUBE_CLICK_CATCHER="youtubeClickCatcher",ximpel.mediaTypeDefinitions.YouTube.prototype.STATE_PLAYING="state_youtube_playing",ximpel.mediaTypeDefinitions.YouTube.prototype.STATE_PAUSED="state_youtube_paused",ximpel.mediaTypeDefinitions.YouTube.prototype.STATE_STOPPED="state_youtube_stopped",ximpel.mediaTypeDefinitions.YouTube.prototype.mediaPlay=function(){if(this.state!==this.STATE_PLAYING)if(this.state!==this.STATE_PAUSED){if(this.state=this.STATE_PLAYING,!ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise)var e=this.loadYoutubeApi();this.initYoutubeElements();var t=new $.Deferred,i=$.when(e,t);if(this.readyToPlayPromise=i.promise(),i.done(function(){this.playYoutube()}.bind(this)),"resolved"===ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise.state())this.loadYoutubePlayer(t);else if("pending"===ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise.state())ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise.done(function(){this.loadYoutubePlayer(t)}.bind(this));else if("rejected"===ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise.state())return void ximpel.warn("YouTube.mediaPlay(): failed to play the youtube element the youtube API didn't load properly.")}else this.resumePlayback()},ximpel.mediaTypeDefinitions.YouTube.prototype.resumePlayback=function(){this.state=this.STATE_PLAYING,this.readyToPlayPromise&&"resolved"===this.readyToPlayPromise.state()&&this.youtubePlayer.playVideo()},ximpel.mediaTypeDefinitions.YouTube.prototype.loadYoutubeApi=function(){if(!ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise){var e=new $.Deferred;ximpel.mediaTypeDefinitions.YouTube.apiLoadPromise=e.promise();var t=window.onYouTubeIframeAPIReady;return window.onYouTubeIframeAPIReady=function(){e.resolve(),t&&t()}.bind(this),this.requestYoutubeApiScript(e),e}},ximpel.mediaTypeDefinitions.YouTube.prototype.requestYoutubeApiScript=function(e){return $.ajax({type:"GET",url:"https://www.youtube.com/iframe_api",dataType:"script",cache:!0}).fail(function(t,i,s){ximpel.warn("YouTube.loadYoutubeApi(): failed to load the youtube api script ("+i+", "+s+")"),e.reject()}.bind(this)),e.promise()},ximpel.mediaTypeDefinitions.YouTube.prototype.loadYoutubePlayer=function(e){return this.youtubePlayer=new YT.Player(this.$youtubePlaceholder[0],{videoId:this.videoId,height:this.height,width:this.width,events:{onError:this.youtubePlayerErrorHandler.bind(this,e),onReady:function(){e.resolve()}.bind(this),onStateChange:this.youtubePlayerStateChangeHandler.bind(this)},playerVars:{html5:1,autoplay:0,controls:0,rel:0,showinfo:0,disablekb:1,wmode:"opaque",modestbranding:0,iv_load_policy:3,start:this.startTime}}),e},ximpel.mediaTypeDefinitions.YouTube.prototype.playYoutube=function(){this.repositionYoutubeIframe(),this.mute?this.youtubePlayer.mute():this.youtubePlayer.unMute(),this.youtubePlayer.playVideo(),this.$youtubeContainer.show()},ximpel.mediaTypeDefinitions.YouTube.prototype.initYoutubeElements=function(){this.$youtubeContainer=$("<div></div>"),this.$youtubePlaceholder=$("<div></div>"),this.$youtubeClickCatcher=$("<div></div>"),this.$youtubeContainer.addClass(this.CLASS_YOUTUBE_CONTAINER),this.$youtubeClickCatcher.addClass(this.CLASS_YOUTUBE_CLICK_CATCHER),this.$youtubeContainer.add(this.$youtubeClickCatcher).css({position:"absolute",width:"100%",height:"100%",top:"0px",left:"0px","z-index":1}),this.$youtubeContainer.hide(),this.$youtubeClickCatcher.appendTo(this.$youtubeContainer),this.$youtubeContainer.appendTo(this.$attachTo),this.$youtubePlaceholder.appendTo(this.$youtubeContainer)},ximpel.mediaTypeDefinitions.YouTube.prototype.repositionYoutubeIframe=function(){var e=this.$youtubeContainer.find("iframe");if(e.css({position:"absolute"}),"center"===this.x)t=Math.round(Math.abs(this.$attachTo.width()-e.width())/2)+"px";else var t=this.x;if("center"===this.y)i=Math.round(Math.abs(this.$attachTo.height()-e.height())/2)+"px";else var i=this.y;e.css({left:t,top:i})},ximpel.mediaTypeDefinitions.YouTube.prototype.youtubePlayerErrorHandler=function(e,t){2==t.data?ximpel.warn("YouTube.youtubePlayerErrorHandler(): invalid parameters received. Possibly the video id is invalid."):5==t.data?ximpel.warn("YouTube.youtubePlayerErrorHandler(): The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred."):100==t.data?ximpel.warn("YouTube.youtubePlayerErrorHandler(): The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private."):101==t.data||150==t.data?ximpel.warn("YouTube.youtubePlayerErrorHandler(): The owner of the requested video does not allow it to be played in embedded players."):ximpel.warn("YouTube.youtubePlayerErrorHandler(): An unknown error has occured while starting the youtube player."),e.reject()},ximpel.mediaTypeDefinitions.YouTube.prototype.youtubePlayerStateChangeHandler=function(e){switch(e.data){case YT.PlayerState.ENDED:this.ended()}},ximpel.mediaTypeDefinitions.YouTube.prototype.mediaPause=function(){this.state===this.STATE_PLAYING&&(this.state=this.STATE_PAUSED,this.youtubePlayer&&this.youtubePlayer.pauseVideo&&this.youtubePlayer.pauseVideo())},ximpel.mediaTypeDefinitions.YouTube.prototype.mediaStop=function(){this.state!==this.STATE_STOPPED&&(this.state=this.STATE_STOPPED,this.youtubePlayer.pauseVideo(),this.youtubePlayer.destroy(),this.$youtubeContainer.remove(),this.$youtubeContainer=null,this.$youtubePlaceholder=null,this.$youtubeClickCatcher=null,this.youtubePlayer=null,this.readyToPlayPromise=null)},ximpel.mediaTypeDefinitions.YouTube.prototype.getPlayTime=function(){return this.youtubePlayer&&this.youtubePlayer.getCurrentTime?1e3*this.youtubePlayer.getCurrentTime()-1e3*this.startTime:0},ximpel.mediaTypeDefinitions.YouTube.prototype.mediaIsPlaying=function(){return this.state===this.STATE_PLAYING},ximpel.mediaTypeDefinitions.YouTube.prototype.mediaIsPaused=function(){return this.state===this.STATE_PAUSED},ximpel.mediaTypeDefinitions.YouTube.prototype.mediaIsStopped=function(){return this.state===this.STATE_STOPPED};var mediaTypeRegistrationObject=new ximpel.MediaTypeRegistration("youtube",ximpel.mediaTypeDefinitions.YouTube,{allowedAttributes:["mute","videoId","width","height","x","y","startTime"],requiredAttributes:["videoId"],allowedChildren:["source"],requiredChildren:["source"]});ximpel.registerMediaType(mediaTypeRegistrationObject);